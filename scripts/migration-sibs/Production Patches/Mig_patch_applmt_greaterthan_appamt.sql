/* Patching for cases where approved limit is greater than applied amount */

------------------------------------------------------------------------------------------------------------------------------------------------------------
-- Query to extract the above case
select lmt.CMS_LSP_APPR_LMTS_ID, facmas.ID as CMS_FAC_MASTER_ID, lmt.LMT_ID, lmt.LMT_LE_ID as CIF_ID, lmt.LOS_BCA_REF_NUM, 
    lmt.CMS_BKG_ORGANISATION as BRANCH_CODE, lmt.LMT_FAC_TYPE_VALUE as FACILITY_CODE, aa.APPLICATION_TYPE, aa.APPLICATION_LAW_TYPE, 
    facgen.APPLICATION_DATE, facgen.APPROVED_DATE, facgen.OFFER_ACCEPTED_DATE, facgen.OFFER_DATE, lmt.LMT_AMT as APPROVED_LIMIT, 
    facgen.FINANCED_AMOUNT as APPLIED_AMOUNT 
from SCI_LSP_LMT_PROFILE aa, SCI_LSP_APPR_LMTS lmt, CMS_FACILITY_MASTER facmas, CMS_FAC_GENERAL facgen 
where aa.CMS_LSP_LMT_PROFILE_ID = lmt.CMS_LIMIT_PROFILE_ID 
and lmt.CMS_LSP_APPR_LMTS_ID = facmas.CMS_LSP_APPR_LMTS_ID 
and facmas.ID = facgen.CMS_FAC_MASTER_ID 
and lmt.LMT_AMT > facgen.FINANCED_AMOUNT  
order by APPLICATION_TYPE;

------------------------------------------------------------------------------------------------------------------------------------------------------------
drop table PATCH_APP_LIMIT_AMOUNT_TEMP;

create table PATCH_APP_LIMIT_AMOUNT_TEMP (
    CMS_FAC_MASTER_ID 				BIGINT,
	CMS_LSP_APPR_LMTS_ID 			BIGINT,
	LMT_ID                          VARCHAR(43),
	LMT_LE_ID                       VARCHAR(20),
	LOS_BCA_REF_NUM					VARCHAR(35),
	LMT_AMT                         DECIMAL(20,2),
	FINANCED_AMOUNT             	DECIMAL(20,2)
) in CMS_MIG index in CMS_MIG_INDEX;

------------------------------------------------------------------------------------------------------------------------------------------------------------
="insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('"&D5&"', '"&E5&"', '"&F5&"', "&R5&", "&S5&");"

insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('65090020392141', '120434280', 'MO-800065-090129-000001', 0, 231928);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('65090022112111', '200323153', 'MO-800065-090416-000003', 0, 59355);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('77090062262201', '130427120', 'MO-800077-090304-000001', 0, 23723);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('36050003082712', '260057569', 'MO-800036-050714-000001', 0, 1287);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('91090021702141', '10041880', 'MO-800091-090212-000001', 536960, 536960);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('91090021702142', '10041880', 'MO-800091-090212-000001', 542960, 542960);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('178080006592141', '10235705', 'MO-800178-081124-000001', 270000, 270000);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('18080197912203', '120362874', 'MO-800018-090122-000001', 252390, 252390);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('18080201702141', '140250004', 'MO-800018-081211-000001', 477000, 423000);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('18080197912202', '120362874', 'MO-800018-090122-000001', 252390, 252390);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('18090210072201', '30254661', 'MO-800018-090211-000001', 37000, 15000);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('18080195202142', '230017970', 'MO-800018-081008-000002', 550000, 372500);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('18080197912201', '120362874', 'MO-800018-090122-000001', 292468, 292468);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('18080205082111', '140282673', 'MO-800018-090105-000001', 38754, 37800);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('18090215532142', '190343718', 'MO-800018-090325-000002', 309698, 302262);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('53080090132141', '200275344', 'MO-800053-081128-000001', 122831, 125000);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('61050007112711', '30247456', 'MO-800061-050909-000001', 114990, 114990);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('71090017192721', '190367983', 'MO-800071-090417-000001', 111287, 111287);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('72080029012711', '180125052', 'MO-800072-081201-000001', 143025, 138300);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('2006092900242141', '110197543', 'MO-000049-090526-004306', 280000, 280000);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('114090027731101', '250033427', 'MO-800114-090331-000001', 0, 40000);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('27960000671103', '80005888', 'MO-800027-960705-000001', 160000, 160000);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('27090069232711', '190366582', 'MO-800027-090323-000001', 0, 136735);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('8090022812141', '200005352', 'MO-800008-090416-000002', 260800, 260800);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('103080018442731', '120409686', 'MO-800103-081016-000001', 101844, 101844);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('174080012952701', '190355606', 'MO-800174-081120-000001', 241892, 241892);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('2005092879082721', '30276173', 'MO-002005-090428-001791', 140000, 140000);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('50990000782131', '130055790', 'MO-800050-991201-000001', 39800, 39800);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('101080026702731', '120424353', 'MO-800101-081030-000001', 207646, 207646);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('2060025291101', '190284218', 'MO-800002-061010-000001', 0, 400000);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('2090054222111', '120435167', 'MO-800002-090304-000001', 0, 39568);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('5090007182721', '130028004', 'MO-800005-090421-000001', 0, 198000);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('100080013362731', '30217413', 'MO-800100-081204-000001', 143607, 143607);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('181090037182731', '250006216', 'MO-000181-090416-000913', 45000, 45000);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('181090036262771', '120388578', 'MO-800181-090402-000001', 234892, 234892);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('2017092826402111', '110193596', 'MO-802017-090319-000002', 37500, 37500);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('2021061571831101', '50031876', 'MO-802021-060809-000001', 100000, 100000);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('22090077332151', '190363595', 'MO-800022-090212-000002', 100642, 100642);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('31080008592111', '30042474', 'MO-800031-081217-000002', 47500, 47500);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('56090009742142', '110194169', 'MO-800056-090406-000001', 331142, 331142);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('168080044952711', '120350586', 'MO-800168-080306-000001', 0, 20213);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('2018082921732701', '130264539', 'MO-802018-080407-000001', 0, 478392);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('2018052823912141', '130101289', 'MO-802018-050609-000001', 0, 474680);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('2018092968982711', '80154681', 'MO-802018-090122-000001', 0, 404800);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('39080013292731', '200309645', 'MO-800039-080910-000001', 0, 117447);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('46080034792771', '250024684', 'MO-800046-080807-000001', 0, 386382);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('60010001411101', '230001935', 'MO-800060-011031-000001', 0, 250000);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('163080024332151', '10281492', 'MO-800163-081105-000001', 0, 215226);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('92070019941101', '160064476', 'MO-800092-080917-000001', 0, 170000);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('92090030992771', '160094427', 'MO-800092-090331-000001', 0, 240354);

insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('683090000137191', '190170547', 'MO-000183-090421-001251', 7593, 7593);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('663060001767522', '30157006', 'MO-800663-060825-000001', 0, 254000);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('665080056877331', '190143420', 'MO-800665-081203-000001', 3243.76, 3243.76);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('667080052627332', '100092718', 'MO-800667-081212-000001', 0, 1489.68);

insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('2044042853795421', '250076559', 'SF-802044-040519-000001', 4500000, 4500000);
insert into PATCH_APP_LIMIT_AMOUNT_TEMP (LMT_ID, LMT_LE_ID, LOS_BCA_REF_NUM, LMT_AMT, FINANCED_AMOUNT) values ('905070032425421', '120339922', 'SF-800905-070507-000001', 500000, 500000);

------------------------------------------------------------------------------------------------------------------------------------------------------------
-- Update primary keys to be patching into actual and stagin tables
update PATCH_APP_LIMIT_AMOUNT_TEMP tmp
set (tmp.CMS_LSP_APPR_LMTS_ID) = (select CMS_LSP_APPR_LMTS_ID from SCI_LSP_APPR_LMTS lmt
									where lmt.LMT_ID = tmp.LMT_ID
									and lmt.LMT_LE_ID = tmp.LMT_LE_ID)
where exists (select 1 from SCI_LSP_APPR_LMTS lmt1
				where lmt1.LMT_ID = tmp.LMT_ID
				and lmt1.LMT_LE_ID = tmp.LMT_LE_ID fetch first row only);

update PATCH_APP_LIMIT_AMOUNT_TEMP tmp
set (tmp.CMS_FAC_MASTER_ID) = (select ID from CMS_FACILITY_MASTER facmas
								where facmas.CMS_LSP_APPR_LMTS_ID = tmp.CMS_LSP_APPR_LMTS_ID)
where exists (select 1 from CMS_FACILITY_MASTER facmas1
				where facmas1.CMS_LSP_APPR_LMTS_ID = tmp.CMS_LSP_APPR_LMTS_ID fetch first row only);

------------------------------------------------------------------------------------------------------------------------------------------------------------
DROP INDEX TEMP_IDX_001;
DROP INDEX TEMP_IDX_002;
DROP INDEX TEMP_IDX_003;
DROP INDEX TEMP_IDX_004;
DROP INDEX TEMP_IDX_005;
DROP INDEX TEMP_IDX_006;
DROP INDEX TEMP_IDX_007;
DROP INDEX TEMP_IDX_008;

CREATE INDEX TEMP_IDX_001 ON "PATCH_APP_LIMIT_AMOUNT_TEMP" 
("CMS_LSP_APPR_LMTS_ID" ASC, "LMT_AMT" DESC) 
ALLOW REVERSE SCANS ; 

CREATE UNIQUE INDEX TEMP_IDX_002 ON "SCI_LSP_APPR_LMTS" 
("CMS_LSP_APPR_LMTS_ID" ASC) 
INCLUDE ( "LMT_AMT") 
ALLOW REVERSE SCANS ; 

CREATE INDEX TEMP_IDX_003 ON "PATCH_APP_LIMIT_AMOUNT_TEMP" 
("LMT_ID" ASC, "LMT_LE_ID" DESC) 
ALLOW REVERSE SCANS ; 

CREATE INDEX TEMP_IDX_004 ON "STAGE_LIMIT" 
("LMT_AMT" ASC, "LMT_ID" ASC, "LMT_LE_ID" ASC) 
ALLOW REVERSE SCANS ; 

CREATE INDEX TEMP_IDX_005 ON "PATCH_APP_LIMIT_AMOUNT_TEMP" 
("CMS_FAC_MASTER_ID" ASC, "FINANCED_AMOUNT" DESC) 
ALLOW REVERSE SCANS ; 

CREATE UNIQUE INDEX TEMP_IDX_006 ON "CMS_FAC_GENERAL" 
("CMS_FAC_MASTER_ID" ASC) 
INCLUDE ( "FINANCED_AMOUNT") 
ALLOW REVERSE SCANS ; 

CREATE UNIQUE INDEX TEMP_IDX_007 ON "CMS_FACILITY_MASTER" 
("ID" ASC) 
INCLUDE ( "CMS_LSP_APPR_LMTS_ID") 
ALLOW REVERSE SCANS ; 

CREATE UNIQUE INDEX TEMP_IDX_008 ON "CMS_STG_FAC_GENERAL" 
("CMS_FAC_MASTER_ID" ASC) 
INCLUDE ( "FINANCED_AMOUNT") 
ALLOW REVERSE SCANS ; 

------------------------------------------------------------------------------------------------------------------------------------------------------------

-- Update  approved limit to actual tables
update SCI_LSP_APPR_LMTS lmt
set lmt.LMT_AMT = (select tmp.LMT_AMT from PATCH_APP_LIMIT_AMOUNT_TEMP tmp
					where tmp.CMS_LSP_APPR_LMTS_ID = lmt.CMS_LSP_APPR_LMTS_ID
					and tmp.LMT_AMT > 0)
where exists (select 1 from PATCH_APP_LIMIT_AMOUNT_TEMP tmp
				where tmp.CMS_LSP_APPR_LMTS_ID = lmt.CMS_LSP_APPR_LMTS_ID
				and tmp.LMT_AMT > 0 fetch first row only);

-- Update approved limit to staging table				
update STAGE_LIMIT lmt
set lmt.LMT_AMT = (select tmp.LMT_AMT from PATCH_APP_LIMIT_AMOUNT_TEMP tmp
					where tmp.LMT_ID = lmt.LMT_ID
					and tmp.LMT_LE_ID = lmt.LMT_LE_ID
					and tmp.LMT_AMT > 0)
where exists (select 1 from PATCH_APP_LIMIT_AMOUNT_TEMP tmp
				where tmp.LMT_ID = lmt.LMT_ID
				and tmp.LMT_LE_ID = lmt.LMT_LE_ID
				and tmp.LMT_AMT > 0 fetch first row only);


-- Update applied amount to actual table
update CMS_FAC_GENERAL facgen
set facgen.FINANCED_AMOUNT = (select tmp.FINANCED_AMOUNT from PATCH_APP_LIMIT_AMOUNT_TEMP tmp
								where tmp.CMS_FAC_MASTER_ID = facgen.CMS_FAC_MASTER_ID
								and tmp.FINANCED_AMOUNT > 0)
where exists (select 1 from PATCH_APP_LIMIT_AMOUNT_TEMP tmp
				where tmp.CMS_FAC_MASTER_ID = facgen.CMS_FAC_MASTER_ID
				and tmp.FINANCED_AMOUNT > 0 fetch first row only);

-- Update applied amount to staging table	
update CMS_STG_FAC_GENERAL facgen
set facgen.FINANCED_AMOUNT = (select tmp.FINANCED_AMOUNT from PATCH_APP_LIMIT_AMOUNT_TEMP tmp, CMS_STG_FACILITY_MASTER facmas
								where tmp.CMS_LSP_APPR_LMTS_ID = facmas.CMS_LSP_APPR_LMTS_ID
								and facmas.ID = facgen.CMS_FAC_MASTER_ID
								and tmp.FINANCED_AMOUNT > 0)
where exists (select 1 from PATCH_APP_LIMIT_AMOUNT_TEMP tmp, CMS_STG_FACILITY_MASTER facmas
				where tmp.CMS_LSP_APPR_LMTS_ID = facmas.CMS_LSP_APPR_LMTS_ID
				and facmas.ID = facgen.CMS_FAC_MASTER_ID
				and tmp.FINANCED_AMOUNT > 0 fetch first row only);