CREATE OR REPLACE PROCEDURE SP_PARTY_SCREEN_MIG
AS
  CURSOR PARTY_MIG
  IS
    SELECT LSP_LE_ID,
      LSP_SHORT_NAME,
      CMS_LE_SUB_PROFILE_ID,
      CMS_LE_MAIN_PROFILE_ID,
      LSP_SGMNT_CODE_VALUE,
      LISTED_COMPANY,
      YEAR_END_PERIOD,
      RARAOC_PERIOD,
      RAROC,
      ISIN_NO,
      CREDIT_MANAGER_EMPLOYEE_ID,
      PF_LRD_CREDIT_MANAGER_EMPLOYEE_ID,
      CREDIT_MANAGERS_SEGMENT
    FROM TEMP_CHANGES_PARTY
    WHERE UPDATE_STATUS = 'N' AND IS_VALIDATED = 'Y';
  RC_FLAG_UPDATE PARTY_MIG%ROWTYPE;
  COUNT_ACTUAL NUMBER(10);
BEGIN
  OPEN PARTY_MIG;
  LOOP
    FETCH PARTY_MIG INTO RC_FLAG_UPDATE;
    EXIT
  WHEN PARTY_MIG%NOTFOUND;
    COUNT_ACTUAL := 0;
    SELECT COUNT(1)
    INTO COUNT_ACTUAL
    FROM SCI_LE_SUB_PROFILE
    WHERE LSP_LE_ID = RC_FLAG_UPDATE.LSP_LE_ID;
    IF(COUNT_ACTUAL >0) THEN
      UPDATE SCI_LE_SUB_PROFILE
      SET LISTED_COMPANY                  = RC_FLAG_UPDATE.LISTED_COMPANY,
	  ISIN_NO                       = RC_FLAG_UPDATE.ISIN_NO,
        YEAR_END_PERIOD                   = RC_FLAG_UPDATE.YEAR_END_PERIOD,
        RARAOC_PERIOD                     = RC_FLAG_UPDATE.RARAOC_PERIOD,
        RAROC                             = RC_FLAG_UPDATE.RAROC,
        CREDIT_MGR_EMPID        = RC_FLAG_UPDATE.CREDIT_MANAGER_EMPLOYEE_ID,
        PF_LRD_CREDIT_MGR_EMPID = RC_FLAG_UPDATE.PF_LRD_CREDIT_MANAGER_EMPLOYEE_ID,
        CREDIT_MGR_SEGMENT           = RC_FLAG_UPDATE.CREDIT_MANAGERS_SEGMENT
      WHERE LSP_LE_ID                     = RC_FLAG_UPDATE.LSP_LE_ID;
      
      UPDATE SCI_LE_MAIN_PROFILE
      SET LISTED_COMPANY                  = RC_FLAG_UPDATE.LISTED_COMPANY,
	  ISIN_NO                       = RC_FLAG_UPDATE.ISIN_NO,
        YEAR_END_PERIOD                   = RC_FLAG_UPDATE.YEAR_END_PERIOD,
        RARAOC_PERIOD                     = RC_FLAG_UPDATE.RARAOC_PERIOD,
        RAROC                             = RC_FLAG_UPDATE.RAROC,
        CREDIT_MGR_EMPID        = RC_FLAG_UPDATE.CREDIT_MANAGER_EMPLOYEE_ID,
        PF_LRD_CREDIT_MGR_EMPID = RC_FLAG_UPDATE.PF_LRD_CREDIT_MANAGER_EMPLOYEE_ID,
        CREDIT_MGR_SEGMENT           = RC_FLAG_UPDATE.CREDIT_MANAGERS_SEGMENT
      WHERE LMP_LE_ID                     = RC_FLAG_UPDATE.LSP_LE_ID;
      
      UPDATE STAGE_SCI_LE_SUB_PROFILE
      SET LISTED_COMPANY                  = RC_FLAG_UPDATE.LISTED_COMPANY,,
	  ISIN_NO                       = RC_FLAG_UPDATE.ISIN_NO,
        YEAR_END_PERIOD                   = RC_FLAG_UPDATE.YEAR_END_PERIOD,
        RARAOC_PERIOD                     = RC_FLAG_UPDATE.RARAOC_PERIOD,
        RAROC                             = RC_FLAG_UPDATE.RAROC,
        CREDIT_MGR_EMPID        = RC_FLAG_UPDATE.CREDIT_MANAGER_EMPLOYEE_ID,
        PF_LRD_CREDIT_MGR_EMPID = RC_FLAG_UPDATE.PF_LRD_CREDIT_MANAGER_EMPLOYEE_ID,
        CREDIT_MGR_SEGMENT           = RC_FLAG_UPDATE.CREDIT_MANAGERS_SEGMENT
      WHERE LSP_LE_ID                     = RC_FLAG_UPDATE.LSP_LE_ID;
      
      UPDATE STAGE_SCI_LE_MAIN_PROFILE
      SET LISTED_COMPANY                  = RC_FLAG_UPDATE.LISTED_COMPANY,
	  ISIN_NO                       = RC_FLAG_UPDATE.ISIN_NO,
        YEAR_END_PERIOD                   = RC_FLAG_UPDATE.YEAR_END_PERIOD,
        RARAOC_PERIOD                     = RC_FLAG_UPDATE.RARAOC_PERIOD,
        RAROC                             = RC_FLAG_UPDATE.RAROC,
        CREDIT_MGR_EMPID        = RC_FLAG_UPDATE.CREDIT_MANAGER_EMPLOYEE_ID,
        PF_LRD_CREDIT_MGR_EMPID = RC_FLAG_UPDATE.PF_LRD_CREDIT_MANAGER_EMPLOYEE_ID,
        CREDIT_MGR_SEGMENT           = RC_FLAG_UPDATE.CREDIT_MANAGERS_SEGMENT
      WHERE LMP_LE_ID                     = RC_FLAG_UPDATE.LSP_LE_ID;
	  
	  
      UPDATE TEMP_CHANGES_PARTY
      SET UPDATE_STATUS           = 'Y'
      WHERE CMS_LE_SUB_PROFILE_ID = RC_FLAG_UPDATE.CMS_LE_SUB_PROFILE_ID;
      
      
    END IF;
   
  END LOOP;
  CLOSE PARTY_MIG;
  COMMIT;
END;