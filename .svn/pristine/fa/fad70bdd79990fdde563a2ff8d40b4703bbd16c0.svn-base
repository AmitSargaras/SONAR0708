create or replace PROCEDURE SP_BACKUP_EROSION_DATA
AS
  V_EXTRACTDATE DATE;
  V_ROWCOUNT    NUMBER(19) := 0;
BEGIN
  SELECT COUNT(1)
  INTO V_ROWCOUNT
  FROM
    (SELECT rownum n,
      logDate
    FROM
      ( SELECT DISTINCT TRUNC (fac.TRN_DATE) logDate
      FROM CLMS_TRQ_PRON_RPT_CUST_FAC fac
      ORDER BY logDate DESC
      )
    )
  WHERE n       >2;
  IF V_ROWCOUNT > 0 THEN
    -- Finding extration date i.e. date before 2 months.
    SELECT DISTINCT TRN_DATE
    INTO V_EXTRACTDATE
    FROM CLMS_TRQ_PRON_RPT_CUST_FAC where TRN_DATE < add_months(sysdate, -2);
    -- Backup old records
    INSERT INTO CLMS_TRQ_PRON_RPT_CUST_FAC_BKP
    SELECT *
    FROM CLMS_TRQ_PRON_RPT_CUST_FAC
    WHERE TRUNC(CLMS_TRQ_PRON_RPT_CUST_FAC.TRN_DATE)=V_EXTRACTDATE;
    INSERT INTO CLMS_TRQ_PRON_RPT_FAC_BKP
    SELECT *
    FROM CLMS_TRQ_PRON_RPT_FAC
    WHERE TRUNC(CLMS_TRQ_PRON_RPT_FAC.TRN_DATE)=V_EXTRACTDATE;
    COMMIT;
    --Clean up old Records
    DELETE
    FROM CLMS_TRQ_PRON_RPT_CUST_FAC
    WHERE TRUNC(CLMS_TRQ_PRON_RPT_CUST_FAC.TRN_DATE)=V_EXTRACTDATE;
    DELETE
    FROM CLMS_TRQ_PRON_RPT_FAC
    WHERE TRUNC(CLMS_TRQ_PRON_RPT_FAC.TRN_DATE)=V_EXTRACTDATE;
    COMMIT;
  END IF;
END;