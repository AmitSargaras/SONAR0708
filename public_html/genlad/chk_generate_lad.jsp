<%@ page import="com.integrosys.cms.app.ddn.trx.IDDNTrxValue,
                 com.integrosys.cms.app.ddn.bus.IDDN,
                 com.integrosys.cms.app.ddn.bus.IDDNCustomerDetail,
                 com.integrosys.cms.app.ddn.bus.DDNCollateralInfo,
                 com.integrosys.base.techinfra.logger.DefaultLogger,
                 com.integrosys.base.businfra.currency.Amount,
                 com.integrosys.cms.app.ddn.bus.IDDNItem,
                 java.util.*,
				 com.integrosys.cms.app.common.util.*,
                 com.integrosys.base.techinfra.diff.CompareOBUtil,
                 com.integrosys.component.commondata.app.CommonDataSingleton,
                 com.integrosys.cms.ui.customer.CategoryCodeConstant,
                 com.integrosys.cms.ui.common.CountryList,
                 com.integrosys.cms.app.limit.bus.ILimitProfile,
                 com.integrosys.cms.app.common.constant.ICMSConstant,
                 com.integrosys.cms.ui.common.constant.IGlobalConstant,
				 com.integrosys.base.uiinfra.common.ICommonEventConstant,
				 com.integrosys.cms.app.checklist.bus.ICheckListItem,
                 com.integrosys.cms.app.transaction.OBCMSTrxHistoryLog,                 
                 com.integrosys.cms.ui.common.OrgCodeList"%>
<%@ page import="com.integrosys.base.techinfra.diff.CompareResult" %>
<%@ page import="com.integrosys.cms.app.chktemplate.bus.IDocumentHeld" %>
<%@ page import="com.integrosys.base.techinfra.propertyfile.PropertyManager" %>
<%@ page import="com.integrosys.cms.app.collateral.bus.ICollateral" %>
<%@ page import="com.integrosys.cms.app.chktemplate.bus.OBDocumentHeld" %>
<%@ page import="com.integrosys.cms.app.checklist.proxy.ICheckListProxyManager" %>
<%@ page import="com.integrosys.cms.app.checklist.proxy.CheckListProxyManagerFactory" %>
<%@ page import="com.integrosys.cms.app.checklist.bus.ICheckList" %>

<%@ taglib uri="/WEB-INF/struts-bean.tld" prefix="bean" %>
<%@ taglib uri="/WEB-INF/struts-html.tld" prefix="html" %>
<%@ taglib uri="/WEB-INF/struts-logic.tld" prefix="logic" %>
<%@ taglib uri="/WEB-INF/IntegroTag.tld" prefix="integro" %>
<%
/**
* Copyright Integro Technologies Pte Ltd
* $Header: /home/cms2/cvsroot/cms2/public_html/genddn/chk_generate_ddn.jsp,v 1.51 2006/10/27 08:45:31 hmbao Exp $
*
* Display DDN generated by the cpc maker for CPC Checker to process.
* Purpose: Display DDN details made by CPC Maker for CPC Checker processing.
* Description: 
*
* @author $Author: hmbao $<br>
* @version $Revision: 1.51 $
* Date: $Date: 2006/10/27 08:45:31 $
* Tag: $Name:  $
*/
%>
<%try{
    List deferredList = (List) session.getAttribute("com.integrosys.cms.ui.genddn.GenerateDDNAction.deferredList");
    List deferredApprovalList = (List) session.getAttribute("com.integrosys.cms.ui.genddn.GenerateDDNAction.deferredApprovalList");
    HashMap deferredMap = (HashMap) session.getAttribute("com.integrosys.cms.ui.genddn.GenerateDDNAction.deferredMap");
    IDDNTrxValue certTrxVal = (IDDNTrxValue)session.getAttribute("com.integrosys.cms.ui.genddn.GenerateDDNAction.certTrxVal");
    ILimitProfile limit = (ILimitProfile)session.getAttribute(ICommonEventConstant.GLOBAL_SCOPE+"."+IGlobalConstant.GLOBAL_LIMITPROFILE_OBJ);
    ArrayList deferCreditApproverList = (ArrayList)session.getAttribute("com.integrosys.cms.ui.genddn.GenerateDDNAction.deferCreditApproverList");
    System.out.println("::::::::::::deferCreditApproverList::::::::::::::"+deferCreditApproverList);
    IDDN cert = (IDDN)session.getAttribute("com.integrosys.cms.ui.genddn.GenerateDDNAction.cert");
    IDDNCustomerDetail custDetail = (IDDNCustomerDetail)session.getAttribute("com.integrosys.cms.ui.genddn.GenerateDDNAction.custDetail");
    if(custDetail!=null){
        pageContext.setAttribute("custDetail",custDetail);
    }
    if(cert!=null) {        
        pageContext.setAttribute("cert",cert);
    }
    IDDN actCert = certTrxVal.getDDN();
	String userRemarks = request.getParameter("remarks");
	if (userRemarks == null) userRemarks = "";
    
	String remarks = "";
    String lastActionBy = "";
    String status = "";
	if(certTrxVal!=null) {
        status = certTrxVal.getStatus();
        remarks = certTrxVal.getRemarks();
        lastActionBy = certTrxVal.getUserInfo();
	}
    if(lastActionBy==null) lastActionBy = "";
    if (remarks==null) remarks= "";

//    int row = 0;
//    int usno = 0;
//    int ssno = 0;

//    Amount cleanAppAmt = null;
//    Amount notCleanAppAmt = null;
//    Amount cleanActAmt = null;
//    Amount notCleanActAmt = null;
//    Amount cleanDDNAmt = null;
//    Amount notCleanDDNAmt = null;
//
//    if(cert!=null){
//        cleanAppAmt = cert.getCleanApprovalAmount();
//        notCleanAppAmt = cert.getApprovalAmount();
//        cleanActAmt = cert.getCleanActivatedAmount();
//        notCleanActAmt = cert.getActivatedAmount();
//        cleanDDNAmt = cert.getCleanDDNAmount();
//        notCleanDDNAmt = cert.getDDNAmount();
//    }

//    IDDNItem arrayActualClean[] = null;
//    IDDNItem arrayStagingClean[] = null;
//    IDDNItem arrayActualNotClean[] = null;
//    IDDNItem arrayStagingNotClean[] = null;
    IDDNItem arrayActual[] = null;
    IDDNItem arrayStaging[] = null;
//
    if (certTrxVal.getDDN()==null){
//        arrayActualClean = null;
//        arrayActualNotClean = null;
        arrayActual = null;
    }
    else {
//        arrayActualClean = certTrxVal.getDDN().getCleanDDNItemList();
//        arrayActualNotClean = certTrxVal.getDDN().getNotCleanDDNItemList();
        arrayActual = certTrxVal.getDDN().getDDNItemList();
    }
/*
	if(arrayActualNotClean!=null){
		DefaultLogger.debug(this,"--------- arrayActualNotClean size  -"+arrayActualNotClean.length);
    }else{
    	DefaultLogger.debug(this,"--------- arrayActualNotClean 	  -"+arrayActualNotClean);
    }
    if(arrayActualClean!=null){
		DefaultLogger.debug(this,"--------- arrayActualClean size     -"+arrayActualClean.length);
    }else{
    	DefaultLogger.debug(this,"--------- arrayActualClean          -"+arrayActualClean);
    }
    if(arrayStagingNotClean!=null){
		DefaultLogger.debug(this,"--------- arrayStagingNotClean size  -"+arrayStagingNotClean.length);
    }else{
    	DefaultLogger.debug(this,"--------- arrayStagingNotClean 	  -"+arrayStagingNotClean);
    }
    if(arrayStagingClean!=null){
		DefaultLogger.debug(this,"--------- arrayStagingClean size     -"+arrayStagingClean.length);
    }else{
    	DefaultLogger.debug(this,"--------- arrayStagingClean          -"+arrayStagingClean);
    }
*/

    if(arrayActual!=null){
		DefaultLogger.debug(this,"--------- arrayActual size     -"+arrayActual.length);
    }else{
    	DefaultLogger.debug(this,"--------- arrayActual          -"+arrayActual);
    }

    if (certTrxVal.getStagingDDN()!=null) {
        	
//    	Date approveDate = certTrxVal.getStagingDDN().getApprovalDate();
//    	if(approveDate==null){
//    		certTrxVal.getStagingDDN().setApprovalDate(new Date());
//    	}
    	//DefaultLogger.debug(this,"set Approval Date "+certTrxVal.getStagingDDN().getApprovalDate());
	      // secured items
//        arrayStagingClean = certTrxVal.getStagingDDN().getCleanDDNItemList();
        arrayStaging = certTrxVal.getStagingDDN().getDDNItemList();

        if(arrayStaging!=null){
            DefaultLogger.debug(this,"--------- arrayStaging size     -"+arrayStaging.length);
        }else{
            DefaultLogger.debug(this,"--------- arrayStaging          -"+arrayStaging);
        }

//	    if(arrayStagingClean!=null){
//			DefaultLogger.debug(this,"--------- arrayStagingClean size -"+arrayStagingClean.length);
//	    }else{
//	    	DefaultLogger.debug(this,"--------- arrayStagingClean      -"+arrayStagingClean);
//	    }
//	      if (arrayStagingClean != null && arrayActualClean == null) {
        if (arrayStaging != null && arrayActual == null) {
//	      DefaultLogger.debug(this,"@@@ Copy Clean items to EMPTY Actual. ");
		      // copy arrayStagingClean to arrayActualClean
//		      arrayActualClean = new IDDNItem[arrayStagingClean.length];
//					for (int i=0; i<arrayStagingClean.length; i++) {
//						arrayActualClean[i] = (IDDNItem) arrayStagingClean[i].clone();
//					}
//					// set the ddn amount of each ddn item to 0
//					for (int i = 0; arrayActualClean != null && i < arrayActualClean.length; i++) {
//						IDDNItem actualItem = arrayActualClean[i];
//						if (actualItem != null && actualItem.getDDNAmount() != null) {
//							String currencyCode = actualItem.getDDNAmount().getCurrencyCode();
//							actualItem.setDDNAmount(new Amount(0, currencyCode));
//						}
//					}
            arrayActual = new IDDNItem[arrayStaging.length];
            for (int i = 0; i < arrayStaging.length; i++) {
                arrayActual[i] = (IDDNItem) arrayStaging[i].clone();
            }
//	      }else if (arrayStagingClean != null && arrayActualClean != null){
        }else if (arrayStaging != null && arrayActual != null){
            if (false) {// not sure what is the purpose of this...since we have the castor comparison
//	      DefaultLogger.debug(this,"@@@ Select Clean items for Actual according to staging data. ");
//	      	 IDDNItem arrayActualCleanTmp[] = new IDDNItem[arrayStagingClean.length];
            IDDNItem arrayActualCleanTmp[] = new IDDNItem[arrayStaging.length];
	      	 int k=0;
//	      	for (int i=0; i<arrayStagingClean.length; i++) {
//	      	boolean found = false;
//	      	IDDNItem stagingItem = arrayStagingClean[i];
//	      		for (int j=0; j<arrayActualClean.length; j++) {
//	      			IDDNItem actualItem = arrayActualClean[j];
//
//	      			if( actualItem.getDDNItemRef()== stagingItem.getDDNItemRef()){
//		      			DefaultLogger.debug(this,"CLEAN IDDNitem Match "+actualItem.getDDNItemRef());
//		      			arrayActualCleanTmp[k++]= actualItem;
//		      			found = true;
//	      			}
//	      		}
//	      		if(!found){
//	      			DefaultLogger.debug(this,"CLEAN IDDNitem Insert "+stagingItem.getDDNItemRef());
//	      			arrayActualCleanTmp[k++]= stagingItem;
//	      		}
//	      	}
//	      	arrayActualClean = arrayActualCleanTmp;
            for (int i=0; i<arrayStaging.length; i++) {
	      	boolean found = false;
	      	IDDNItem stagingItem = arrayStaging[i];
	      		for (int j=0; j<arrayActual.length; j++) {
	      			IDDNItem actualItem = arrayActual[j];

	      			if( actualItem.getDDNItemRef()== stagingItem.getDDNItemRef()){
//		      			DefaultLogger.debug(this,"CLEAN IDDNitem Match "+actualItem.getDDNItemRef());
		      			arrayActualCleanTmp[k++]= actualItem;
		      			found = true;
	      			}
	      		}
	      		if(!found){
//	      			DefaultLogger.debug(this,"CLEAN IDDNitem Insert "+stagingItem.getDDNItemRef());
	      			arrayActualCleanTmp[k++]= stagingItem;
	      		}
	      	}
	      	arrayActual = arrayActualCleanTmp;
            }    
	      }else if (arrayStaging == null ){
//	      	DefaultLogger.debug(this,"@@@ CLEAN Staging is empty, set actual to empty.");
	      	arrayActual = null;
	      }

//	      // unsecured items
//        arrayStagingNotClean = certTrxVal.getStagingDDN().getNotCleanDDNItemList();
//                   	if(arrayStagingNotClean!=null){
//		DefaultLogger.debug(this,"--------- arrayStagingNotClean size -"+arrayStagingNotClean.length);
//    }else{
//    	DefaultLogger.debug(this,"--------- arrayStagingNotClean      -"+arrayStagingNotClean);
//    }
//	      if (arrayStagingNotClean != null && arrayActualNotClean == null) {
//			DefaultLogger.debug(this,"%%% Copy Not Clean items to EMPTY Actual. ");
//		      // copy arrayStagingNotClean to arrayActualNotClean
//		      arrayActualNotClean = new IDDNItem[arrayStagingNotClean.length];
//					for (int i=0; i<arrayStagingNotClean.length; i++) {
//						arrayActualNotClean[i] = (IDDNItem) arrayStagingNotClean[i].clone();
//					}
//					// set the ddn amount of each ddn item to 0
//					for (int i = 0; arrayActualNotClean != null && i < arrayActualNotClean.length; i++) {
//						IDDNItem actualItem = arrayActualNotClean[i];
//						if (actualItem != null && actualItem.getDDNAmount() != null) {
//							String currencyCode = actualItem.getDDNAmount().getCurrencyCode();
//							actualItem.setDDNAmount(new Amount(0, currencyCode));
//						}
//					}
//	      }else if (arrayStagingNotClean != null && arrayActualNotClean != null){
//	      DefaultLogger.debug(this,"%%% Select Not Clean items for Actual according to staging data. ");
//	      	 IDDNItem arrayActualNotCleanTmp[] = new IDDNItem[arrayStagingNotClean.length];
//
//	      	 int k=0;
//	      	for (int i=0; i<arrayStagingNotClean.length; i++) {
//	      		boolean found = false;
//	      		IDDNItem stagingItem = arrayStagingNotClean[i];
//	      		for (int j=0; j<arrayActualNotClean.length; j++) {
//	      			IDDNItem actualItem = arrayActualNotClean[j];
//
//	      			if( actualItem.getDDNItemRef()== stagingItem.getDDNItemRef()){
//		      			DefaultLogger.debug(this,"NOTCLEAN IDDNitem Match "+actualItem.getDDNItemRef());
//		      			arrayActualNotCleanTmp[k++]= actualItem;
//		      			found = true;
//	      			}
//	      		}
//	      		if(!found){
//	      			DefaultLogger.debug(this,"NOTCLEAN IDDNitem Insert "+stagingItem.getDDNItemRef());
//	      			arrayActualNotCleanTmp[k++]= stagingItem;
//	      		}
//	      	}
//	      	arrayActualNotClean = arrayActualNotCleanTmp;
//	      }else if (arrayStagingNotClean == null ){
//	      	DefaultLogger.debug(this,"%%% NOTCLEAN Staging is empty, set actual to empty.");
//	      	arrayActualNotClean = null;
//	      }
    }

//    if(arrayActualNotClean!=null){
//		DefaultLogger.debug(this,"--------- arrayActualNotClean size  -"+arrayActualNotClean.length);
//    }else{
//    	DefaultLogger.debug(this,"--------- arrayActualNotClean 	  -"+arrayActualNotClean);
//    }
//    if(arrayActualClean!=null){
//		DefaultLogger.debug(this,"--------- arrayActualClean size     -"+arrayActualClean.length);
//    }else{
//    	DefaultLogger.debug(this,"--------- arrayActualClean          -"+arrayActualClean);
//    }
//    if(arrayStagingNotClean!=null){
//		DefaultLogger.debug(this,"--------- arrayStagingNotClean size  -"+arrayStagingNotClean.length);
//    }else{
//    	DefaultLogger.debug(this,"--------- arrayStagingNotClean 	  -"+arrayStagingNotClean);
//    }
//    if(arrayStagingClean!=null){
//		DefaultLogger.debug(this,"--------- arrayStagingClean size     -"+arrayStagingClean.length);
//    }else{
//    	DefaultLogger.debug(this,"--------- arrayStagingClean          -"+arrayStagingClean);
//    }
    if(arrayActual!=null){
		DefaultLogger.debug(this,"--------- arrayActual size     -"+arrayActual.length);
    }else{
    	DefaultLogger.debug(this,"--------- arrayActual          -"+arrayActual);
    }
    if(arrayStaging!=null){
		DefaultLogger.debug(this,"--------- arrayStaging size     -"+arrayStaging.length);
    }else{
    	DefaultLogger.debug(this,"--------- arrayStaging          -"+arrayStaging);
    }

    for (int i = 0; i < arrayActual.length; i++) {
        IDDNItem iddnItem = (IDDNItem) arrayActual[i];
        DefaultLogger.debug(this, "Actual DDN Item " + i + " : " + iddnItem.toString());
    }

    for (int i = 0; i < arrayStaging.length; i++) {
        IDDNItem iddnItem = (IDDNItem) arrayStaging[i];
        DefaultLogger.debug(this, "Staging DDN Item " + i + " : " + iddnItem.toString());
    }

    List cleanRes = null;
//    List notCleanRes = null;
//    if (!(arrayStagingClean == null && arrayActualClean == null)) {
//	    cleanRes = CompareOBUtil.compOBArray(arrayStagingClean,arrayActualClean);
//    }
    if (!(arrayStaging == null && arrayActual == null)) {
	    cleanRes = CompareOBUtil.compOBArray(arrayStaging,arrayActual);
    }
//    if(!(arrayStagingNotClean == null && arrayActualNotClean == null)) {
//        for (int ii = 0; ii < arrayActualNotClean.length; ii++) {
//            IDDNItem iddnItem = (IDDNItem) arrayActualNotClean[ii];
//        }
//	    //notCleanRes = CompareOBUtil.compOBArray(arrayStagingNotClean,arrayActualNotClean);
//        notCleanRes = new ArrayList();
//        for (int ii = 0; ii < arrayStagingNotClean.length; ii++) {
//            CompareResult cr = new CompareResult(arrayStagingNotClean[ii], "indexdiff");
//            cr.setModified(true);
//            cr.setOriginal(arrayActualNotClean[ii]);
//            notCleanRes.add(cr);
//        }
//    }   
    
    ArrayList cleanList = null;
//    ArrayList notCleanList = null;
    
    if(cleanRes!=null) {
        cleanList = new ArrayList(cleanRes);
    }
//    if(notCleanRes!=null) {
//        notCleanList = new ArrayList(notCleanRes);
//    }
    if(cleanList!=null)
        pageContext.setAttribute("cleanddnitems",cleanList);

//    if(notCleanList!=null)
//        pageContext.setAttribute("notcleanddnitems",notCleanList);

//    String creditgrade = null;
//    String creditGradeName = "-";
//
//    if(custDetail!=null) {
//        if (custDetail.getCreditGrade() != null)
//        {
//            creditgrade = custDetail.getCreditGrade().getCGCode();
//            if (creditgrade != null) {
//                creditGradeName = CommonDataSingleton.getCodeCategoryLabelByValue("19", creditgrade.toString());
//            }
//        }
//    }
//
//    CountryList cList = CountryList.getInstance();
//    OrgCodeList orgList = OrgCodeList.getInstance(temp);


//    Date bcaApprovedDate = ((ILimitProfile)session.getAttribute(
//            ICommonEventConstant.GLOBAL_SCOPE+"."+IGlobalConstant.GLOBAL_LIMITPROFILE_OBJ)).getApprovalDate();

//    GregorianCalendar cal = new GregorianCalendar();
    //cal.setTime(bcaApprovedDate);
//    cal.setTime(new Date());

	// get BFL final issue date.
//	String bflFinalIssueDateStr = (String) request.getAttribute("bflFinalIssueDate");
//	DefaultLogger.debug(this," * bflFinalIssueDateStr = "+bflFinalIssueDateStr);
//	if(bflFinalIssueDateStr==null || bflFinalIssueDateStr.equals("")) bflFinalIssueDateStr="-";
	
	
	
	// clean remark.
/*	if(remarks!=null){
		int spaceInd = 0;
		for(int i=0;i<remarks.length(); ){
			char x = remarks.charAt(i);
			if(x != ' '){
				if((i-spaceInd)>59){
					remarks = remarks.substring(0,i+1)+" "+remarks.substring(i+1);
					i= i+1;
					spaceInd = i;								
				}
			}else{
				spaceInd = i;
			}
			i++;
		}
	}*/
	
	//CMS 1995 by Hai Tao
//	    boolean anyDeletedLimit = false ;

    // list out all the checklist (CC & Security) for particular CUSTOMER
    HashMap docListMap = (HashMap) request.getAttribute("docsHeldMap");

    /**
     * will list down all the deferred list base on the checklist level...starting from CC to Security
     * for CC , here is the category for listing , [Main Borrower, Joint Borrower, Co Borrower, Pledger, Non Borrower]
     * for Security , get the list from docListMap by key SECURITY
     * */
    ArrayList ccList = new ArrayList();
    ccList.add(ICMSConstant.CHECKLIST_MAIN_BORROWER);
    ccList.add(ICMSConstant.CHECKLIST_JOINT_BORROWER);
    ccList.add(ICMSConstant.CHECKLIST_CO_BORROWER);
    ccList.add(ICMSConstant.CHECKLIST_PLEDGER);
    ccList.add(ICMSConstant.CHECKLIST_NON_BORROWER);

    ArrayList securityList = new ArrayList();
    securityList.add(ICMSConstant.CHECKLIST_SECURITY);
    
    ArrayList facilityList = new ArrayList();
    facilityList.add(ICMSConstant.CHECKLIST_FACILITY);
    ArrayList camList = new ArrayList();
    camList.add(ICMSConstant.CHECKLIST_CAM);
%>



<html><!-- InstanceBegin template="/Templates/ContentWinLayout.dwt" codeOutsideHTMLIsLocked="false" -->
<head>
<!-- InstanceBeginEditable name="doctitle" -->
<title>Untitled Document</title>
<!-- InstanceEndEditable -->

<!-- InstanceBeginEditable name="Cssstyle" -->

<!-- InstanceEndEditable -->



<!-- InstanceParam name="showWinTitle" type="boolean" value="true" -->
<!-- InstanceParam name="showWinStatus" type="boolean" value="false" -->

 <!-- InstanceParam name="showContentMenuBar" type="boolean" value="true" -->
 <!-- InstanceParam name="showContentTitleBar" type="boolean" value="false" -->
 <!-- InstanceParam name="showContentToolBar" type="boolean" value="false" -->
 <!-- InstanceParam name="showContentNavigatorBar" type="boolean" value="false" -->
 <!-- InstanceParam name="contentWidth" type="text" value="100%" -->
 <!-- InstanceParam name="contentHeight" type="text" value="100%" -->
 <!-- InstanceParam name="contentTitle" type="text" value="Customer Details" -->
 <!-- InstanceParam name="showGeneralPurposeBar" type="boolean" value="false" -->

<!-- InstanceBeginEditable name="head" --> <!-- InstanceEndEditable -->

<script language="JavaScript" type="text/JavaScript">
<!--
function MM_swapImgRestore() { //v3.0
  var i,x,a=document.MM_sr; for(i=0;a&&i<a.length&&(x=a[i])&&x.oSrc;i++) x.src=x.oSrc;
}

function MM_preloadImages() { //v3.0
  var d=document; if(d.images){ if(!d.MM_p) d.MM_p=new Array();
    var i,j=d.MM_p.length,a=MM_preloadImages.arguments; for(i=0; i<a.length; i++)
    if (a[i].indexOf("#")!=0){ d.MM_p[j]=new Image; d.MM_p[j++].src=a[i];}}
}

function MM_findObj(n, d) { //v4.01
  var p,i,x;  if(!d) d=document; if((p=n.indexOf("?"))>0&&parent.frames.length) {
    d=parent.frames[n.substring(p+1)].document; n=n.substring(0,p);}
  if(!(x=d[n])&&d.all) x=d.all[n]; for (i=0;!x&&i<d.forms.length;i++) x=d.forms[i][n];
  for(i=0;!x&&d.layers&&i<d.layers.length;i++) x=MM_findObj(n,d.layers[i].document);
  if(!x && d.getElementById) x=d.getElementById(n); return x;
}

function MM_swapImage() { //v3.0
  var i,j=0,x,a=MM_swapImage.arguments; document.MM_sr=new Array; for(i=0;i<(a.length-2);i+=3)
   if ((x=MM_findObj(a[i]))!=null){document.MM_sr[j++]=x; if(!x.oSrc) x.oSrc=x.src; x.src=a[i+2];}
}

function approve(){
	
    var test = document.forms[0].remarks.value;
    if( test.length > 2000) {
        alert('Remarks field can be only 2000 Characters');
        return false;
    }   
    
    document.forms[0].event.value="approve";
    document.forms[0].submit();
}

function notapprove(){
	
    var isLimiteDeleted = true; 
    if(isLimiteDeleted){
	    alert('Limit(s) in this BCA has / have been deleted. Hence, this is a null and void transaction and has to be rejected / closed.');
        return false;
    }
    
}

function reject(){
    var test = document.forms[0].remarks.value;
    if( test.length > 2000) {
        alert('Remarks field can be only 2000 Characters');
        return false;
    }

    document.forms[0].event.value="reject";
    document.forms[0].submit();
}

function viewDiffOuterLimitBca(outerLimitID, limitID, outerLimitProfileID) {
    var test = document.forms[0].remarks.value;
    if( test.length > 2000) {
        alert('Remarks field can be only 2000 Characters');
        return false;
    }

	document.forms[0].event.value="checker_view_outer_limit_bca";
	document.forms[0].outerLimitID.value=outerLimitID;
	document.forms[0].limitID.value=limitID;
	document.forms[0].outerLimitProfileID.value=outerLimitProfileID;
	document.forms[0].submit();
}

function checkTextSize() {
	var text = document.forms[0].remarks.value;
	var cleaned_text = '';
	var text_array = text.split("<br>");
	//alert(text);
	//alert(text_array);
	if(text_array!=null && text_array.size>0){
		for (i = 0; i < text_array.size; i++){  
			alert ('text_array['+i+'] ='+text_array[i]);
			cleaned_text= cleaned_text+text_array[i];
    	}
    	alert ('Cleaned '+cleaned_text);
		text=cleaned_text;
	}
	if(text==''){
		//alert('empty text');
	}else{
		if(text.length>2000){
			document.all['warningRemarks'].innerHTML = '<font color="#FF0000" size="1"><br>Remarks is too long. Please restrict to 2000 characters.</font>';
			document.forms[0].remarks.value = text.substring(0, 2000);
		}else{
			document.all['warningRemarks'].innerHTML = '';
		}
	}
}
//-->
</script>

</head>

<body leftmargin="0" topmargin="0" marginwidth="0" marginheight="0" onload="MM_preloadImages('img/approve2.gif','img/reject2.gif','img/cancel2.gif')">
<html:form action="GenerateDDN" >
<input type="hidden" name="event" />
<%--<input type="hidden" name="outerLimitID"/>--%>
<%--<input type="hidden" name="limitID"/>--%>
<%--<input type="hidden" name="outerLimitProfileID"/>--%>
<input type="hidden" name="actionName" value="GenerateDDN"/>
<%--<p class="required"><font color="#0000FF">*</font> Mandatory for Submission&nbsp;</p><br>--%>
<!-- InstanceBeginEditable name="menuScript" --> <!-- InstanceEndEditable -->
<%--<table width="100%" height="100%" border="0" cellpadding="0" cellspacing="0">--%>
  <!--DWLayoutTable-->
   <!-- InstanceBeginEditable name="contentCanvas" -->
                    <table width="90%" border="0" align="center" cellpadding="0" cellspacing="0" class="tblFormSection">
                      <thead>
                        <tr>
                          <td><h3>Document Deferral Note (DDN)</h3></td>
                        </tr>
                        <%--
                        <tr>
                          <td><hr /> </td>
                        </tr>
                        --%>
                      </thead>
                      <tbody>
                        <%--
                        <tr>
                          <td><table width="100%" border="0" align="center" cellpadding="0" cellspacing="0" class="tblInfo">
                              <thead>
                                <tr class="odd">
                                  <td colspan="4" style="text-align:left">Customer
                                    Details</td>
                                </tr>
                              </thead>
                              <tbody>
                                <tr class="odd">
                                  <td height="22" class="fieldname">LE ID<br />
                                  </td>
                                  <td>&nbsp;<bean:write name="custDetail" property="legalID"  /></td>
                                  <td class="fieldname">Legal Name</td>
                                  <td>&nbsp;<bean:write name="custDetail" property="legalName"  /></td>
                                </tr>
                                <tr class="even">
                                  <td class="fieldname">Customer Sub-Profile Name<br /> </td>
                                  <td>&nbsp;<bean:write name="custDetail" property="customerName"  /> </td>
                                  <td class="fieldname">Sub-Profile ID</td>
                                  <td>&nbsp;<bean:write name="custDetail" property="customerReference" /></td>
                                </tr>
                                <tr class="odd">
                                  <td class="fieldname">SCB Internal Credit Grade</td>
                                  <td>&nbsp;<%=creditGradeName%></td>
                                  <td class="fieldname">Customer BFL Issue Date</td>
                                  <td>&nbsp;<%=bflFinalIssueDateStr%></td>
                                </tr>
                                <tr class="even">
                                  <td class="fieldname">FAM</td>                                  
                                  <%
                                  	//String fam = custDetail.getFamCode() + ", " + custDetail.getFamName();
                                        String famCode =  (custDetail.getFamCode() != null)?  custDetail.getFamCode() :"-";
				     	String famName =  (custDetail.getFamName() != null)?  custDetail.getFamName() :"-";
    					String fam = famCode + ", " + famName ;
                                  %>
                                  <td><integro:empty-if-null value="<%=fam %>" /></td>
                                  <td class="fieldname">DDN Ref. No.</td>
                                  <td><%=custDetail.getLegalID()%>/<%= cert.getDDNRef()%></td>
                                </tr>
                              </tbody>
                            </table></td>
                        </tr>
                        --%>
                      </tbody>
                    </table>


<%--Let inject the deferred list base on checklist level--%>
<!--<table width="90%" border="0" align="center" cellpadding="0" cellspacing="0" class="tblFormSection">
    <tr>
        <td><h3>Constitutional / Contractual Checklist</h3></td>
    </tr>
    <tr>
        <td>
            <hr/>
        </td>
    </tr>
</table>
--><%--CC--%>
<%
    boolean hasCCCheckList = false;
    for (int x = 0; x < ccList.size(); x++) {
        if (!docListMap.containsKey(ccList.get(x))) continue;

        List list = (List) docListMap.get(ccList.get(x));

        for (int xx = 0; xx < list.size(); xx++) {
            if (!hasCCCheckList) hasCCCheckList = true;

            IDocumentHeld docHeld = (IDocumentHeld) list.get(xx);

            %>
            <!--<table width="90%" border="0" align="center" cellpadding="0" cellspacing="0" class="tblFormSection">
                <tr>
                    <td>
                        <table width="100%" border="0" cellspacing="0" cellpadding="0" class="tblInfo">
                            <thead>
                            </thead>
                            <tbody>
                                <tr class="odd">
                                    <td class="fieldname" width="20%">Customer Category</td>
                                    <td width="30%">
                                        <%
                                        String custCat = (String)ccList.get(x);
                                        String showCustCat = null;
                                        if (custCat.equals(ICMSConstant.CHECKLIST_MAIN_BORROWER)) {
                                            showCustCat = "Main Borrower/Hirer";
                                        } else if (custCat.equals(ICMSConstant.CHECKLIST_JOINT_BORROWER)) {
                                            showCustCat = "Joint Borrower";
                                        } else if (custCat.equals(ICMSConstant.CHECKLIST_CO_BORROWER)) {
                                            showCustCat = "Co-Borrower";
                                        } else if (custCat.equals(ICMSConstant.CHECKLIST_PLEDGER)) {
                                            showCustCat = "Pledgor/Guarantor";
                                        } else if (custCat.equals(ICMSConstant.CHECKLIST_NON_BORROWER)) {
                                            showCustCat = "Non-Borrower";
                                        }
                                        %>
                                        <integro:empty-if-null value="<%=showCustCat%>"/>&nbsp;
                                    </td>
                                    <td class="fieldname" width="20%">Customer Name</td>
                                    <td width="30%"><integro:empty-if-null value="<%=docHeld.getLegalName()%>"/>&nbsp;</td>
                                </tr>
                                <tr class="even">
                                    <td class="fieldname" width="20%">CIF No</td>
                                    <td width="30%"><integro:empty-if-null value="<%=docHeld.getLegalID()%>"/>&nbsp;</td>
                                    <td class="fieldname" width="20%">Checklist ID</td>
                                    <td width="30%"><%=docHeld.getCheckListID()%>&nbsp;</td>
                                </tr>
                                <tr class="odd">
                                    <td class="fieldname" width="20%">Checklist Status</td>
                                    <td width="30%">
                                        <%
                                        String checkListStatus = (PropertyManager.getValue("chklist.status." + docHeld.getCheckListStatus()) == null) ?
                                                docHeld.getCheckListStatus() : PropertyManager.getValue("chklist.status." + docHeld.getCheckListStatus());
                                        %>
                                        <integro:empty-if-null value="<%=checkListStatus%>"/>&nbsp;
                                    </td>
                                    <td class="fieldname" width="20%">&nbsp;</td>
                                    <td width="30%">&nbsp;</td>
                                </tr>
                            </tbody>
                        </table>
                    </td>
                </tr>
                <tr><td></td></tr>
                <tr>
                    <td>
                        <table width="100%" border="0" cellspacing="0" cellpadding="0" class="tblFormSection">
                            <thead>
                                <tr>
                                    <td><h3>Deferral Requested For</h3></td>
                                </tr>
                                <tr>
                                    <td>
                                        <hr/>
                                    </td>
                                </tr>
                            </thead>
                            <tbody>
                                <%--Inject the deferred item here--%>
                                <%
                                //boolean hasDeferredItem = deferredMap.containsKey(docHeld.getCheckListID() + "");
                                //if (hasDeferredItem) {
                                //TODO : Yes, this is bad. Redo this when got extra time.
                                boolean hasCCCheckListItem = false;
                                ICheckListProxyManager checkListProxyManager = CheckListProxyManagerFactory.getCheckListProxyManager();
                                ICheckList checkList = checkListProxyManager.getCheckListByID(docHeld.getCheckListID());

                                //let do some arrange for fast lookup
                                HashMap hashLookup = new HashMap();
                                if (checkList != null) {
                                    ICheckListItem[] checkListItem = checkList.getCheckListItemList();
                                    if (checkListItem != null) {
                                        for (int a = 0; a < checkListItem.length; a++) {
                                            hashLookup.put(checkListItem[a].getCheckListItemRef() + "", null);
                                        }
                                    }
                                }

                                for (int z = 0; z < cleanList.size(); z++) {
                                    CompareResult cr = (CompareResult) cleanList.get(z);
                                    IDDNItem iddnItem = (IDDNItem)cr.getObj();

                                    if (!hashLookup.containsKey(iddnItem.getDocNumber() + "")) continue;//not belong to this checklist

                                    if (!hasCCCheckListItem) {
                                        hasCCCheckListItem = true;
                                        break;
                                    }
                                }

                                if (hasCCCheckListItem) {
                                    %>
                                    <tr>
                                        <td>
                                            <table width="100%" border="0" cellspacing="0" cellpadding="0" class="tblInfo">
                                                <thead>
                                                    <tr>
                                                        <td width="5%">S/N</td>
                                                        <td width="12%">Doc Number</td>
                                                        <td width="10%">Doc Code</td>
                                                        <td width="21%">Doc Description</td>
                                                        <td width="5%">Date Defer</td>
                                                        <td width="5%">Expected Date of Return</td>
                                                        <td width="5%">Doc Status</td>
                                                        <td width="15%">Action Party</td>
                                                        <td width="10%">Approval Date</td>
                                                        <td width="12%">Approved By</td>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <%
                                                    int _row = 0;
                                                    for (int z = 0; z < cleanList.size(); z++) {
                                                        CompareResult cr = (CompareResult) cleanList.get(z);
                                                        IDDNItem iddnItem = (IDDNItem)cr.getObj();

                                                        if (!hashLookup.containsKey(iddnItem.getDocNumber() + "")) continue;//not belong to this checklist
                                                        //System.out.println("Key : " + cr.getKey());
                                                        //OBCMSTrxHistoryLog log = new OBCMSTrxHistoryLog();
                                                        //if (deferredApprovalList != null && deferredApprovalList.size() > z)
                                                        //    log = (OBCMSTrxHistoryLog) deferredApprovalList.get(z);

                                                        String rowClass = "";
                                                        _row++;
                                                        if (_row % 2 != 0) {
                                                            rowClass = "odd";
                                                        } else {
                                                            rowClass = "even";
                                                        }

                                                        %>
                                                        <tr class="<%=rowClass%>">
                                                            <td class="<%=cr.getKey()%>"><%=_row%></td>
                                                            <td><%=iddnItem.getDocNumber()%>&nbsp;</td>
                                                            <td><%=iddnItem.getDocCode()%>&nbsp;</td>
                                                            <td><%=iddnItem.getDocDesc()%>&nbsp;</td>
                                                            <td><integro:date object="<%=iddnItem.getDateDefer()%>"/>&nbsp;</td>
                                                            <td><integro:date object="<%=iddnItem.getDateOfReturn()%>"/>&nbsp;</td>
                                                            <td><%=iddnItem.getDocStatus()%>&nbsp;</td>
                                                            <td><integro:empty-if-null value="<%=iddnItem.getActionParty()%>"/>&nbsp;</td>
                                                            <td><integro:date object="<%=iddnItem.getTheApprovalDate()%>"/>&nbsp;</td>
                                                            <td><integro:empty-if-null value="<%=iddnItem.getApprovedBy()%>"/>&nbsp;</td>
                                                        </tr>
                                                        <%
                                                    }
                                                    %>
                                                </tbody>
                                            </table>
                                        </td>
                                    </tr>
                                    <%
                                } else {
                                    %>
                                    <tr class="odd">
                                        <td>There is no deferred document.</td>
                                    </tr>
                                    <%
                                }
                                %>
                            </tbody>
                        </table>
                    </td>
                </tr>
                <tr><td></td></tr>
                <tr><td></td></tr>
            </table>
            --><%
        }
    }

    if (!hasCCCheckList) {
        %>
<!--        <table width="97%" border="0" align="center" cellspacing="0" cellpadding="0" class="tblInfo">-->
<!--            <tr class="odd">-->
<!--                <td>There is no document.</td>-->
<!--            </tr>-->
<!--        </table>-->
        <%
    }
%>
<%--cam --%>

<table width="90%" border="0" align="center" cellpadding="0" cellspacing="0" class="tblFormSection">
    <tr>
        <td><h3>CAM Checklist</h3></td>
    </tr>
    <tr>
        <td>
            <hr/>
        </td>
    </tr>
</table>
<%--CAM --%>
<%
    boolean hasCamCheckList = false;
    for (int x = 0; x < camList.size(); x++) {//Main Borrower, Co-Borrower....
        if (!docListMap.containsKey(camList.get(x))) continue;

        List list = (List) docListMap.get(camList.get(x));

        System.out.println("Total Document cam  : " + list.size());

        for (int xx = 0; xx < list.size(); xx++) {
            if (!hasCamCheckList) hasCamCheckList = true;

            IDocumentHeld docHeld = (IDocumentHeld) list.get(xx);

            //checking on the document...any of this document belong to this checklistID?
            boolean hasDeferredItem = deferredMap.containsKey(docHeld.getCheckListID() + "");
            if (hasDeferredItem) {
            %>
            <table width="90%" border="0" align="center" cellpadding="0" cellspacing="0" class="tblFormSection">
                <tr>
                    <td>
                        <table width="100%" border="0" cellspacing="0" cellpadding="0" class="tblInfo">
                            <thead>
                            </thead>
                            <tbody>
<!--                                <tr class="odd">-->
<!--                                    <td class="fieldname" width="20%">Customer Category</td>-->
<!--                                    <td width="30%">-->
                                        <%
                                        String custCat = (String)ccList.get(x);
                                        String showCustCat = null;
                                        if (custCat.equals(ICMSConstant.CHECKLIST_MAIN_BORROWER)) {
                                            showCustCat = "Main Borrower/Hirer";
                                        } else if (custCat.equals(ICMSConstant.CHECKLIST_JOINT_BORROWER)) {
                                            showCustCat = "Joint Borrower";
                                        } else if (custCat.equals(ICMSConstant.CHECKLIST_CO_BORROWER)) {
                                            showCustCat = "Co-Borrower";
                                        } else if (custCat.equals(ICMSConstant.CHECKLIST_PLEDGER)) {
                                            showCustCat = "Pledgor/Guarantor";
                                        } else if (custCat.equals(ICMSConstant.CHECKLIST_NON_BORROWER)) {
                                            showCustCat = "Non-Borrower";
                                        }
                                        %>
<!--                                        <integro:empty-if-null value="<%=showCustCat%>"/>&nbsp;-->
<!--                                    </td>-->
<!--                                    <td class="fieldname" width="20%">Customer Name</td>-->
<!--                                    <td width="30%"><integro:empty-if-null value="<%=docHeld.getLegalName()%>"/>&nbsp;</td>-->
<!--                                </tr>-->
                                <tr class="even">
<!--                                    <td class="fieldname" width="20%">CIF No</td>-->
<!--                                    <td width="30%"><integro:empty-if-null value="<%=docHeld.getLegalID()%>"/>&nbsp;</td>-->
                                    <td class="fieldname" width="20%">Checklist ID</td>
                                    <td width="30%"><%=docHeld.getCheckListID()%>&nbsp;</td>
                                </tr>
                                <tr class="odd">
                                    <td class="fieldname" width="20%">Checklist Status</td>
                                    <td width="30%">
                                        <%        
                                        String checkListStatus = (PropertyManager.getValue("chklist.status." + docHeld.getCheckListStatus()) == null) ?
                                                docHeld.getCheckListStatus() : PropertyManager.getValue("chklist.status." + docHeld.getCheckListStatus());
                                        %>
                                        <integro:empty-if-null value="<%=checkListStatus%>"/>&nbsp;
                                    </td>
                                    
                                </tr>
                                <tr class="odd">
                                    <td class="fieldname" width="20%">Checklist Type</td>
                                    <td width="30%">
                                        CAM&nbsp;
                                    </td>
                                    
                                </tr>
                            </tbody>
                        </table>
                    </td>
                </tr>
                <tr><td></td></tr>
                <tr>
                    <td>
                        <table width="100%" border="0" cellspacing="0" cellpadding="0" class="tblFormSection">
                            <thead>
                                <tr>
                                    <td><h3>Deferral Requested For</h3></td>
                                </tr>
                                <tr>
                                    <td>
                                        <hr/>
                                    </td>
                                </tr>
                            </thead>
                            <tbody>
                                <%--Inject the deferred item here--%>
                                <%
                                //boolean hasDeferredItem = deferredMap.containsKey(docHeld.getCheckListID() + "");
                                //if (hasDeferredItem) {
                                    %>
                                    <tr>
                                        <td>
                                            <table width="100%" border="0" cellspacing="0" cellpadding="0" class="tblInfo">
                                                <thead>
                                                    <tr>
                                                        <td width="5%">S/N</td>
                                                        <td width="12%">Doc Number</td>
                                                        <td width="10%">Doc Code</td>
                                                        <td width="21%">Doc Description</td>
                                                        <td width="5%">Date Defer</td>
                                                        <td width="5%">Next Due Date</td>
                                                        <td width="5%">Doc Status</td>
<!--                                                        <td width="15%">Action Party</td>--><td width="8%">Credit Approver</td>
                                                        <td width="10%">Approval Date</td>
                                                        <td width="12%">Approved By</td>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <%
                                                    ArrayList curDeferredList = (ArrayList) deferredMap.get(docHeld.getCheckListID() + "");
                                                    int _row = 0;
                                                    for (int z = 0; z < curDeferredList.size(); z++) {
                                                        ICheckListItem item = (ICheckListItem) curDeferredList.get(z);

                                                        OBCMSTrxHistoryLog log = new OBCMSTrxHistoryLog();
                                                        if (deferredApprovalList != null && deferredApprovalList.size() > z)
                                                            log = (OBCMSTrxHistoryLog) deferredApprovalList.get(z);

                                                        String rowClass = "";
                                                        _row++;
                                                        if (_row % 2 != 0) {
                                                            rowClass = "odd";
                                                        } else {
                                                            rowClass = "even";
                                                        }
                                                             
                                                        %>
                                                        <tr class="<%=rowClass%>">
                                                            <td class="index"><%=_row%></td>
                                                            <td><%=item.getCheckListItemRef()%>&nbsp;<input type="hidden" name="docNumber" value="<%=item.getCheckListItemRef()%>"/></td>
                                                            <td><%=item.getItemCode()%>&nbsp;<input type="hidden" name="docCode" value="<%=item.getItemCode()%>"/></td>
                                                            <td><%=item.getItemDesc()%>&nbsp;<input type="hidden" name="docDesc" value="<%=item.getItemDesc()%>"/></td>
                                                            <td><integro:date object="<%=item.getDeferExpiryDate()%>"/>&nbsp;<input type="hidden" name="dateDefer" value="<%=item.getDeferExpiryDate()%>"/></td>
                                                            <td><integro:date object="<%=item.getExpectedReturnDate()%>"/>&nbsp;<input type="hidden" name="dateOfReturn" value="<%=item.getExpectedReturnDate()%>"/></td>
                                                            <td><%=item.getItemStatus()%>&nbsp;<input type="hidden" name="docStatus" value="<%=item.getItemStatus()%>"/></td>
                                                            <td><integro:empty-if-null value="<%=item.getActionParty()%>"/>&nbsp;<input type="hidden" name="actionParty" value="<%=item.getActionParty()%>"/></td>
                                                            <%
                                                            Calendar cal2 = null;
                                                            if (log.getLogDate()!= null) {
                                                                //cal2 = new GregorianCalendar(Integer.parseInt(log.getLogDate().substring(6,10)), Integer.parseInt(log.getLogDate().substring(3,5))-1, Integer.parseInt(log.getLogDate().substring(0,2)) );
                                                                String logDate = log.getLogDate().indexOf(" ") != -1 ? log.getLogDate().split(" ")[0] : "";
                                                                String[] temp = logDate.indexOf("/") != -1 ? logDate.split("/") : null;
                                                                String year = null;
                                                                String month = null;
                                                                String day = null;
                                                                if (temp != null) {
                                                                    day = temp[0];
                                                                    month = temp[1];
                                                                    year = temp[2];

                                                                    cal2 = new GregorianCalendar(Integer.parseInt(year), Integer.parseInt(month) - 1, Integer.parseInt(day));
                                                                }
                                                            }
                                                            %>
                                                            <td><% if (cal2 != null) { %><integro:date object="<%=cal2.getTime()%>"/><input type="hidden" name="theApprovalDate" value="<%=cal2.getTime()%>"/><% } else { %>&nbsp;<% } %></td>
                                                            <%
                                                            String approvedBy = "";
                                                            String userName = log.getLogUserName() == null ? "-" : log.getLogUserName();
                                                            String groupName = log.getLogGroupName() == null ? "-" : log.getLogGroupName();
                                                            approvedBy = userName + " (" + groupName + ")";
                                                            %>
                                                            <td><%--<integro:empty-if-null value="<%=log.getLogUserName()%>"/>&nbsp;(<integro:empty-if-null value="<%=log.getLogGroupName()%>"/>)--%><%=approvedBy%><input type="hidden" name="approvedBy" value="<%=approvedBy%>"/></td>
                                                        </tr>
                                                        <%
                                                    }
                                                    %>
                                                </tbody>
                                            </table>
                                        </td>
                                    </tr>
                                    <%
                                //} else {
                                    %>
                                    <%--
                                    <tr class="odd">
                                        <td>There is no deferred document.</td>
                                    </tr>
                                    --%>
                                    <%
                                //}
                                %>
                            </tbody>
                        </table>
                    </td>
                </tr>
                <tr><td></td></tr>
                <tr><td></td></tr>
            </table>
            <%
            }
        }
    }

    if (!hasCamCheckList) {
        %>
        <table width="97%" border="0" align="center" cellspacing="0" cellpadding="0" class="tblInfo">
            <tr class="odd">
                <td>There is no CAM checklist.</td>
            </tr>
        </table>
        <%
    }
%>

<table width="90%" border="0" align="center" cellpadding="0" cellspacing="0" class="tblFormSection">
    <tr>
        <td><h3>Facility Checklist</h3></td>
    </tr>
    <tr>
        <td>
            <hr/>
        </td>
    </tr>
</table>
<%--FACILITY--%>
<%
    boolean hasFacilityCheckList = false;
    for (int x = 0; x < facilityList.size(); x++) {//Main Borrower, Co-Borrower....
        if (!docListMap.containsKey(facilityList.get(x))) continue;

        List list = (List) docListMap.get(facilityList.get(x));

        System.out.println("Total Document facility : " + list.size());

        for (int xx = 0; xx < list.size(); xx++) {
            if (!hasFacilityCheckList) hasFacilityCheckList = true;

            IDocumentHeld docHeld = (IDocumentHeld) list.get(xx);
            System.out.println("Total Document facility : " + docHeld.getCheckListID());
            //checking on the document...any of this document belong to this checklistID?
            boolean hasDeferredItem = deferredMap.containsKey(docHeld.getCheckListID() + "");
            System.out.println("Total Document facility : " + hasDeferredItem);
            if (hasDeferredItem) {
            %>
            <table width="90%" border="0" align="center" cellpadding="0" cellspacing="0" class="tblFormSection">
                <tr>
                    <td>
                        <table width="100%" border="0" cellspacing="0" cellpadding="0" class="tblInfo">
                            <thead>
                            </thead>
                            <tbody>
<!--                                <tr class="odd">-->
<!--                                    <td class="fieldname" width="20%">Customer Category</td>-->
<!--                                    <td width="30%">-->
                                        <%
                                        String custCat = (String)ccList.get(x);
                                        String showCustCat = null;
                                        if (custCat.equals(ICMSConstant.CHECKLIST_MAIN_BORROWER)) {
                                            showCustCat = "Main Borrower/Hirer";
                                        } else if (custCat.equals(ICMSConstant.CHECKLIST_JOINT_BORROWER)) {
                                            showCustCat = "Joint Borrower";
                                        } else if (custCat.equals(ICMSConstant.CHECKLIST_CO_BORROWER)) {
                                            showCustCat = "Co-Borrower";
                                        } else if (custCat.equals(ICMSConstant.CHECKLIST_PLEDGER)) {
                                            showCustCat = "Pledgor/Guarantor";
                                        } else if (custCat.equals(ICMSConstant.CHECKLIST_NON_BORROWER)) {
                                            showCustCat = "Non-Borrower";
                                        }
                                        %>
<!--                                        <integro:empty-if-null value="<%=showCustCat%>"/>&nbsp;-->
<!--                                    </td>-->
<!--                                    <td class="fieldname" width="20%">Customer Name</td>-->
<!--                                    <td width="30%"><integro:empty-if-null value="<%=docHeld.getLegalName()%>"/>&nbsp;</td>-->
<!--                                </tr>-->
                                <tr class="even">
<!--                                    <td class="fieldname" width="20%">CIF No</td>-->
<!--                                    <td width="30%"><integro:empty-if-null value="<%=docHeld.getLegalID()%>"/>&nbsp;</td>-->
                                    <td class="fieldname" width="20%">Checklist ID</td>
                                    <td width="30%"><%=docHeld.getCheckListID()%>&nbsp;</td>
                                </tr>
                                <tr class="odd">
                                    <td class="fieldname" width="20%">Checklist Status</td>
                                    <td width="30%">
                                        <%        
                                        String checkListStatus = (PropertyManager.getValue("chklist.status." + docHeld.getCheckListStatus()) == null) ?
                                                docHeld.getCheckListStatus() : PropertyManager.getValue("chklist.status." + docHeld.getCheckListStatus());
                                        %>
                                        <integro:empty-if-null value="<%=checkListStatus%>"/>&nbsp;
                                    </td>
                                    
                                </tr>
                                <tr class="odd">
                                    <td class="fieldname" width="20%">Checklist Type</td>
                                    <td width="30%">
                                        Facility&nbsp;
                                    </td>
                                    
                                </tr>
                            </tbody>
                        </table>
                    </td>
                </tr>
                <tr><td></td></tr>
                <tr>
                    <td>
                        <table width="100%" border="0" cellspacing="0" cellpadding="0" class="tblFormSection">
                            <thead>
                                <tr>
                                    <td><h3>Deferral Requested For</h3></td>
                                </tr>
                                <tr>
                                    <td>
                                        <hr/>
                                    </td>
                                </tr>
                            </thead>
                            <tbody>
                                <%--Inject the deferred item here--%>
                                <%
                                //boolean hasDeferredItem = deferredMap.containsKey(docHeld.getCheckListID() + "");
                                //if (hasDeferredItem) {
                                    %>
                                    <tr>
                                        <td>
                                            <table width="100%" border="0" cellspacing="0" cellpadding="0" class="tblInfo">
                                                <thead>
                                                    <tr>
                                                        <td width="5%">S/N</td>
                                                        <td width="12%">Doc Number</td>
                                                        <td width="10%">Doc Code</td>
                                                        <td width="21%">Doc Description</td>
                                                        <td width="5%">Date Defer</td>
                                                        <td width="5%">Next Due Date</td>
                                                        <td width="5%">Doc Status</td>
<!--                                                        <td width="15%">Action Party</td>--><td width="8%">Credit Approver</td>
                                                        <td width="10%">Approval Date</td>
                                                        <td width="12%">Approved By</td>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <%
                                                    ArrayList curDeferredList = (ArrayList) deferredMap.get(docHeld.getCheckListID() + "");
                                                    int _row = 0;
                                                    for (int z = 0; z < curDeferredList.size(); z++) {
                                                        ICheckListItem item = (ICheckListItem) curDeferredList.get(z);

                                                        OBCMSTrxHistoryLog log = new OBCMSTrxHistoryLog();
                                                        if (deferredApprovalList != null && deferredApprovalList.size() > z)
                                                            log = (OBCMSTrxHistoryLog) deferredApprovalList.get(z);

                                                        String rowClass = "";
                                                        _row++;
                                                        if (_row % 2 != 0) {
                                                            rowClass = "odd";
                                                        } else {
                                                            rowClass = "even";
                                                        }
                                                             
                                                        %>
                                                        <tr class="<%=rowClass%>">
                                                            <td class="index"><%=_row%></td>
                                                            <td><%=item.getCheckListItemRef()%>&nbsp;<input type="hidden" name="docNumber" value="<%=item.getCheckListItemRef()%>"/></td>
                                                            <td><%=item.getItemCode()%>&nbsp;<input type="hidden" name="docCode" value="<%=item.getItemCode()%>"/></td>
                                                            <td><%=item.getItemDesc()%>&nbsp;<input type="hidden" name="docDesc" value="<%=item.getItemDesc()%>"/></td>
                                                            <td><integro:date object="<%=item.getDeferExpiryDate()%>"/>&nbsp;<input type="hidden" name="dateDefer" value="<%=item.getDeferExpiryDate()%>"/></td>
                                                            <td><integro:date object="<%=item.getExpectedReturnDate()%>"/>&nbsp;<input type="hidden" name="dateOfReturn" value="<%=item.getExpectedReturnDate()%>"/></td>
                                                            <td><%=item.getItemStatus()%>&nbsp;<input type="hidden" name="docStatus" value="<%=item.getItemStatus()%>"/></td>
                                                            <td><integro:empty-if-null value="<%=item.getActionParty()%>"/>&nbsp;<input type="hidden" name="actionParty" value="<%=item.getActionParty()%>"/></td>
                                                            <%
                                                            Calendar cal2 = null;
                                                            if (log.getLogDate()!= null) {
                                                                //cal2 = new GregorianCalendar(Integer.parseInt(log.getLogDate().substring(6,10)), Integer.parseInt(log.getLogDate().substring(3,5))-1, Integer.parseInt(log.getLogDate().substring(0,2)) );
                                                                String logDate = log.getLogDate().indexOf(" ") != -1 ? log.getLogDate().split(" ")[0] : "";
                                                                String[] temp = logDate.indexOf("/") != -1 ? logDate.split("/") : null;
                                                                String year = null;
                                                                String month = null;
                                                                String day = null;
                                                                if (temp != null) {
                                                                    day = temp[0];
                                                                    month = temp[1];
                                                                    year = temp[2];

                                                                    cal2 = new GregorianCalendar(Integer.parseInt(year), Integer.parseInt(month) - 1, Integer.parseInt(day));
                                                                }
                                                            }
                                                            %>
                                                            <td><% if (cal2 != null) { %><integro:date object="<%=cal2.getTime()%>"/><input type="hidden" name="theApprovalDate" value="<%=cal2.getTime()%>"/><% } else { %>&nbsp;<% } %></td>
                                                            <%
                                                            String approvedBy = "";
                                                            String userName = log.getLogUserName() == null ? "-" : log.getLogUserName();
                                                            String groupName = log.getLogGroupName() == null ? "-" : log.getLogGroupName();
                                                            approvedBy = userName + " (" + groupName + ")";
                                                            %>
                                                            <td><%--<integro:empty-if-null value="<%=log.getLogUserName()%>"/>&nbsp;(<integro:empty-if-null value="<%=log.getLogGroupName()%>"/>)--%><%=approvedBy%><input type="hidden" name="approvedBy" value="<%=approvedBy%>"/></td>
                                                        </tr>
                                                        <%
                                                    }
                                                    %>
                                                </tbody>
                                            </table>
                                        </td>
                                    </tr>
                                    <%
                                //} else {
                                    %>
                                    <%--
                                    <tr class="odd">
                                        <td>There is no deferred document.</td>
                                    </tr>
                                    --%>
                                    <%
                                //}
                                %>
                            </tbody>
                        </table>
                    </td>
                </tr>
                <tr><td></td></tr>
                <tr><td></td></tr>
            </table>
            <%
            }
        }
    }

    if (!hasFacilityCheckList) {
        %>
        <table width="97%" border="0" align="center" cellspacing="0" cellpadding="0" class="tblInfo">
            <tr class="odd">
                <td>There is no Facility checklist.</td>
            </tr>
        </table>
        <%
    }
%>

<%--Security--%>
<table width="90%" border="0" align="center" cellpadding="0" cellspacing="0" class="tblFormSection">
    <tr>
        <td><h3>Security Checklist</h3></td>
    </tr>
    <tr>
        <td>
            <hr/>
        </td>
    </tr>
</table>
<%
    boolean hasSecurityCheckList = false;
    for (int x = 0; x < securityList.size(); x++) {
        if (!docListMap.containsKey(securityList.get(x))) continue;

        List list = (List) docListMap.get(securityList.get(x));

        for (int xx = 0; xx < list.size(); xx++) {
            if (!hasSecurityCheckList) hasSecurityCheckList = true;

            IDocumentHeld docHeld = (IDocumentHeld) list.get(xx);
            ICollateral collateral = ((OBDocumentHeld)docHeld).getCollateral();

            //TODO : Yes, this is bad. Redo this when got extra time.
            boolean hasSecurityCheckListItem = false;
            ICheckListProxyManager checkListProxyManager = CheckListProxyManagerFactory.getCheckListProxyManager();
            ICheckList checkList = checkListProxyManager.getCheckListByID(docHeld.getCheckListID());

            %>
            <table width="90%" border="0" align="center" cellpadding="0" cellspacing="0" class="tblFormSection">
                <tr>
                    <td>
                        <table width="100%" border="0" cellspacing="0" cellpadding="0" class="tblInfo">
                            <thead>
                            </thead>
                            <tbody>
                                <tr class="odd">
                                    <td width="20%" class="fieldname">Security Type</td>
                                    <td width="30%"><integro:empty-if-null value="<%=collateral.getCollateralSubType().getTypeName()%>"/>&nbsp;</td>
                                    <td width="20%" class="fieldname">Security Sub-Type</td>
                                    <td width="30%"><integro:empty-if-null value="<%=collateral.getCollateralSubType().getSubTypeName()%>"/>&nbsp;</td>
                                </tr>
                                <tr class="even">
                                    <td width="20%" class="fieldname">Source Security ID</td>
                                    <td width="30%"><integro:empty-if-null value="<%=String.valueOf(collateral.getCollateralID())%>"/>&nbsp;</td>
                                    <td width="20%" class="fieldname">Checklist ID</td>
                                    <td width="30%"><%=docHeld.getCheckListID()%></td>
                                </tr>
                                <tr class="odd">
                                    <td width="20%" class="fieldname">Checklist Status</td>
                                    <td width="30%">
                                        <%
                                        String colCheckListStatus = (PropertyManager.getValue("chklist.status." + docHeld.getCheckListStatus()) ==null) ?
                                                docHeld.getCheckListStatus() : PropertyManager.getValue("chklist.status." + docHeld.getCheckListStatus());
                                        %>
                                        <integro:empty-if-null value="<%=colCheckListStatus%>"/>&nbsp;
                                    </td>
                                    <td width="20%" class="fieldname">&nbsp;</td>
                                    <td width="30%">&nbsp;</td>
                                </tr>
                            </tbody>
                        </table>
                    </td>
                </tr>
                <tr><td></td></tr>
                <tr><td></td></tr>
                <tr><td></td></tr>
                <tr><td></td></tr>
                <tr>
                    <td>
                        <table width="100%" border="0" cellspacing="0" cellpadding="0" class="tblInfo">
                            <thead>
                                <tr align="left">
                                    <td colspan="2" class="fieldname" style="text-align:left">View Security Details - <integro:empty-if-null value="<%=collateral.getCollateralSubType().getTypeName()%>"/></td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="odd">
                                    <td width="30%" class="fieldname">Collateral Details</td>
                                    <td><integro:empty-if-null value="<%=collateral.getSCIReferenceNote()%>"/>&nbsp;</td>
                                </tr>
                                <tr class="even">
                                    <td width="30%" class="fieldname">Remarks</td>
                                    <td><integro:empty-if-null value="<%=checkList.getRemarks()%>"/>&nbsp;</td>
                                </tr>
                            </tbody>
                        </table>
                    </td>
                </tr>
                <tr><td></td></tr>
                <tr>
                    <td>
                        <table width="100%" border="0" cellspacing="0" cellpadding="0" class="tblFormSection">
                            <thead>
                                <tr>
                                    <td><h3>Deferral Requested For</h3></td>
                                </tr>
                                <tr>
                                    <td>
                                        <hr/>
                                    </td>
                                </tr>
                            </thead>
                            <tbody>
                                <%--Inject the deferred item here--%>
                                <%
                                //boolean hasDeferredItem = deferredMap.containsKey(docHeld.getCheckListID() + "");
                                //if (hasDeferredItem) {
                                /*
                                //TODO : Yes, this is bad. Redo this when got extra time.
                                boolean hasSecurityCheckListItem = false;
                                ICheckListProxyManager checkListProxyManager = CheckListProxyManagerFactory.getCheckListProxyManager();
                                ICheckList checkList = checkListProxyManager.getCheckListByID(docHeld.getCheckListID());
                                */
                                //let do some arrange for fast lookup
                                HashMap hashLookup = new HashMap();
                                if (checkList != null) {
                                    ICheckListItem[] checkListItem = checkList.getCheckListItemList();
                                    if (checkListItem != null) {
                                        for (int a = 0; a < checkListItem.length; a++) {
                                            hashLookup.put(checkListItem[a].getCheckListItemRef() + "", null);
                                        }
                                    }
                                }

                                for (int z = 0; z < cleanList.size(); z++) {
                                    CompareResult cr = (CompareResult) cleanList.get(z);
                                    IDDNItem iddnItem = (IDDNItem)cr.getObj();

                                    if (!hashLookup.containsKey(iddnItem.getDocNumber() + "")) continue;//not belong to this checklist

                                    if (!hasSecurityCheckListItem) {
                                        hasSecurityCheckListItem = true;
                                        break;
                                    }
                                }

                                if (hasSecurityCheckListItem) {
                                    %>
                                    <tr>
                                        <td>
                                            <table width="100%" border="0" cellspacing="0" cellpadding="0" class="tblInfo">
                                                <thead>
                                                    <tr>
                                                        <td width="5%">S/N</td>
                                                        <td width="12%">Doc Number</td>
                                                        <td width="10%">Doc Code</td>
                                                        <td width="21%">Doc Description</td>
                                                        <td width="5%">Date Defer</td>
                                                        <td width="5%">Next Due Date</td>
                                                        <td width="5%">Doc Status</td>
<!--                                                        <td width="15%">Action Party</td>--><td width="8%">Credit Approver</td>
                                                        <td width="10%">Approval Date</td>
                                                        <td width="12%">Approved By</td>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <%
                                                    int _row = 0;
                                                    for (int z = 0; z < cleanList.size(); z++) {
                                                        CompareResult cr = (CompareResult) cleanList.get(z);
                                                        IDDNItem iddnItem = (IDDNItem)cr.getObj();

                                                        if (!hashLookup.containsKey(iddnItem.getDocNumber() + "")) continue;//not belong to this checklist
                                                        //System.out.println("Key : " + cr.getKey());
                                                        //OBCMSTrxHistoryLog log = new OBCMSTrxHistoryLog();
                                                        //if (deferredApprovalList != null && deferredApprovalList.size() > z)
                                                        //    log = (OBCMSTrxHistoryLog) deferredApprovalList.get(z);

                                                        String rowClass = "";
                                                        _row++;
                                                        if (_row % 2 != 0) {
                                                            rowClass = "odd";
                                                        } else {
                                                            rowClass = "even";
                                                        }

                                                        %>
                                                        <tr class="<%=rowClass%>">
                                                            <td class="<%=cr.getKey()%>"><%=_row%></td>
                                                            <td><%=iddnItem.getDocNumber()%>&nbsp;</td>
                                                            <td><%=iddnItem.getDocCode()%>&nbsp;</td>
                                                            <td><%=iddnItem.getDocDesc()%>&nbsp;</td>
                                                            <td><integro:date object="<%=iddnItem.getDateDefer()%>"/>&nbsp;</td>
                                                            <td><integro:date object="<%=iddnItem.getDateOfReturn()%>"/>&nbsp;</td>
                                                            <td><%=iddnItem.getDocStatus()%>&nbsp;</td>
                                                            <td><integro:empty-if-null value="<%=iddnItem.getActionParty()%>"/>&nbsp;</td>
                                                            <td><integro:date object="<%=iddnItem.getTheApprovalDate()%>"/>&nbsp;</td>
                                                            <td><integro:empty-if-null value="<%=iddnItem.getApprovedBy()%>"/>&nbsp;</td>
                                                        </tr>
                                                        <%
                                                    }
                                                    %>
                                                </tbody>
                                            </table>
                                        </td>
                                    </tr>
                                    <%
                                } else {
                                    %>
                                    <tr class="odd">
                                        <td>There is no deferred document.</td>
                                    </tr>
                                    <%
                                }
                                %>
                            </tbody>
                        </table>
                    </td>
                </tr>
                <tr><td></td></tr>
                <tr><td></td></tr>
            </table>
            <%
        }
    }

    if (!hasSecurityCheckList) {
        %>
        <table width="90%" border="0" align="center" cellspacing="0" cellpadding="0" class="tblInfo">
            <tr class="odd">
                <td>There is no document.</td>
            </tr>
        </table>
        <%
    }
%>


                    <table width="90%" border="0" align="center" cellpadding="0" cellspacing="0" class="tblFormSection">
                      <thead>
                        <tr>
                          <td><h3>&nbsp;</h3></td>
                        </tr>
                        <tr>
                          <td><hr /></td>
                        </tr>
                        <%--
                        <tr>
                          <td><table width="100%" border="0" cellpadding="0" cellspacing="0" class="tblInput">
                              <thead>
                              </thead>
                              <tbody>
                                <tr class="odd">
                                  <td class="<%=CompareOBUtil.compOB(cert,actCert,"deferredToDate")? "fieldname":"fieldnamediff"%>" width="20%">
                                  	DDN Expiry Date&nbsp;<font color="#0000FF">* </font>
                                  </td>
                                  
                                  <td width="30%">
                                  	&nbsp;<integro:date object="<%=cert.getDeferredToDate()%>" />
                                  </td>
                                  
                                  <td width="20%" class="<%=CompareOBUtil.compOB(cert,actCert,"extendedToDate")? "fieldname":"fieldnamediff"%>" >
                                  	DDN Extended Expiry Date
                                  </td>
                                  
                                  <td width="30%">
                                  	&nbsp;<integro:date object="<%=cert.getExtendedToDate()%>" />
                                  </td>
                                  
                                </tr>
                                <tr class="odd">
                                    <td class="<%=CompareOBUtil.compOB(cert,actCert,"daysValid")? "fieldname":"fieldnamediff"%>" >
                                    	DDN valid for
                                    </td>
                                    
                                    <td >
                                   	<% 	if (cert.getDaysValid()==Integer.MIN_VALUE){%>
                                   			&nbsp;
                                    <% 	}else {  %> 
											<%= cert.getDaysValid()%>
                                    <%  }%>                                   
                                    &nbsp;Days
                                    </td>
                                    
                                    <td width="20%" class="<%=CompareOBUtil.compOB(cert,actCert,"approvalDate")? "fieldname":"fieldnamediff"%>"  >Deferral Approval Date</td>
              						<td width="30%" ><bean:write name="GenerateDDNForm" property="appDate" /></td>

                                    
                                </tr>
                              </tbody>
                            </table></td>
                        </tr>
                        --%>
    <%--
    <tr><td>
		<table width="100%" border="0" align="center" cellpadding="0" cellspacing="0" class="tblInfo">
		  <tbody> 
		    <tr>
		      <td class="fieldname">
		      We certify that all pre-conditions (relating to Contractual & Constitutional and Security Documents) for the draw down of the following limits as detailed in the Business Credit Application dated 
		      <bean:write name="GenerateDDNForm" property="bcaAppDate" />  (as read in conjunction with the deferral approved in respect thereof) have been complied with, physically checked and confirmed to be in order.
		      </td>
		    </tr>
		  </tbody>
		</table>
    </td></tr>
    --%>                <%--
                        <tr>
                          <td>&nbsp;</td>
                        </tr>
                        <tr>
                          <td>The following are Un-Secured Limits:</td>
                        </tr>
                        --%>
                      </thead>
                      <tbody>
                        <%--
                        <tr>
                          <td><table width="100%" border="0" cellspacing="0" cellpadding="0" class="tblInfo">
                              <thead>
                                <tr>
                                  <td width="4%">S/N</td>
                                  <td width="9%">Limit ID</td>
                                  <td width="5%">Co-borrower LE <br>ID/Name</td>
                                  <td width="10%">Limit Booking Location</td>
                                  <td width="7%">Product Desc</td>
                                  <td width="9%">Outer Limit ID</td>
                                  <td width="13%">Approved Limit</td>
                                  <td width="10%">Limit Maturity Date</td>
                                  <td width="13%">DDN Limit&nbsp;<font color="#00AAFF">* </font></td>
                                  <td width="7%">Issue DDN</td>
                                </tr>
                              </thead>
                              <tbody>
<logic:present name="cleanddnitems"  >
   <logic:iterate id="compResult" name="cleanddnitems" type="com.integrosys.base.techinfra.diff.CompareResult"  >
<%
    IDDNItem OB = (IDDNItem)compResult.getObj();
    String rowClass="";
    row++;
    usno++;
    if(usno%2!=0){
       rowClass="odd";
    }else{
       rowClass="even";
    }
    String prodDesc= "-";
    
    //CMS 1995 By Hai Tao
    boolean isDeletedLimit = false;
    if (OB.getLimitStatus() != null) {
        isDeletedLimit = OB.getLimitStatus().equalsIgnoreCase(ICMSConstant.STATE_DELETED);
    }

   		if(isDeletedLimit){
    	anyDeletedLimit = true;
    	}
    
    boolean partial = OB.getIsDDNIssuedInd();
    
	if(OB.getProductDesc()!=null) {
		prodDesc = OB.getProductDesc();
		if(prodDesc !=null)
		{
			if(CommonDataSingleton.getCodeCategoryLabelByValue( CategoryCodeConstant.PRODUCT_DESCRIPTION, prodDesc)!=null)
		   prodDesc=CommonDataSingleton.getCodeCategoryLabelByValue( CategoryCodeConstant.PRODUCT_DESCRIPTION,prodDesc);
		}
	}
   %>
        <tr class="<%=rowClass%>">
        
              <td class=<% if (partial && certTrxVal.getTransactionSubType() == null) { %>
                           'indexdiff'
                        <% } else { %>
	                       '<bean:write name="compResult" property="key" />'
	                    <% } %>><%=usno%></td>
              <td>&nbsp;<%=OB.getLimitRef()%>
                  <%if(isDeletedLimit){%>
                  <br><font color="#FF0000" size="1"><br><strong>(Deleted)</strong></font>
                  <%}%>
              </td>
              
              <td>&nbsp;
              	<integro:empty-if-null value="<%=OB.getCoBorrowerLegalID()%>" />          
              	<br>
              	&nbsp;<integro:empty-if-null value="<%=OB.getCoBorrowerName()%>" />           
              </td>
              
              <td>&nbsp;<%=cList.getCountryName(OB.getLimitBookingLocation().getCountryCode())%> - <%= OB.getLimitBookingLocation().getOrganisationCode()%></td>
              
              <td>&nbsp;<%=prodDesc%></td>
              
              <td <%=!OB.getIsInnerOuterSameBCA()?"class=outerlimit":" "%>>
              	<% 	if (!OB.getIsInnerOuterSameBCA()) { %>
              			<a href="#" onclick="viewDiffOuterLimitBca('<%=OB.getOuterLimitID()%>', '<%=OB.getLimitID()%>', '<%=OB.getOuterLimitProfileID()%>' )" >
              	<% 	} 	%>
              		<%=(OB.getOuterLimitRef()==null || OB.getOuterLimitRef().equals("0")) ? "-" : OB.getOuterLimitRef()%>
              	<% 	if (!OB.getIsInnerOuterSameBCA()) { %> 
              			</a> 
				<% 	} 	%>
              </td>     
                       
              <td class="amount">&nbsp;
                    <integro:currency amount="<%=((IDDNItem)compResult.getObj()).getApprovedLimitAmount()%>" param="currency" />

              	<%	if (OB.isInnerLimit()){	%>
              			(<integro:currency amount="<%=((IDDNItem)compResult.getObj()).getApprovedLimitAmount()%>" param="amount" />)
              	<%	} else { %>
              			<integro:currency amount="<%=((IDDNItem)compResult.getObj()).getApprovedLimitAmount()%>" param="amount" />
              	<%	}	%>
              </td>
              <td><% if (OB.getMaturityDate() == null) { %>
                  -
                  <% } else { %>
                  <integro:date object="<%= OB.getMaturityDate() %>" />
                  <% } %>
              <td class="amount">&nbsp;
                    <integro:currency amount="<%=((IDDNItem)compResult.getObj()).getDDNAmount()%>" param="currency" />
              	<%	if (OB.isInnerLimit()) { %>
	      				(<integro:currency amount="<%=((IDDNItem)compResult.getObj()).getDDNAmount()%>" param="amount" />)
	      		<%	}else{	%>
						<integro:currency amount="<%=((IDDNItem)compResult.getObj()).getDDNAmount()%>" param="amount" />
              	<%	}		%> 
              </td>
              
              <td style="text-align:center"><input name="checkbox" type="checkbox" disabled="true" value="checkbox" <%if(partial) { %>checked  <% }%> /></td>
        </tr>
</logic:iterate>
                        <tr class="odd">
                          <td class="total">&nbsp;</td>
                          <td class="total">&nbsp;</td>
                          <td class="total">&nbsp;</td>
                          <td class="total">&nbsp;</td>
                          <td class="total">&nbsp;</td>
                          <td class="total" style="text-align:right;padding-right:3px">Total</td>
                          <td class="total" style="text-align:right;padding-right:3px">&nbsp;<integro:currency amount="<%=cleanAppAmt%>" /></td>
                          <td class="total">&nbsp;</td>
                          <td class="total" style="text-align:right;padding-right:3px">&nbsp;<integro:currency amount="<%=cleanDDNAmt%>" /></td>
                          <td class="total">&nbsp;</td>
                        </tr>
            </logic:present>
<logic:notPresent name="cleanddnitems" >
            <tr class="odd">
                <td colspan="10">There is no limit</td>
            </tr>
</logic:notPresent>


                              </tbody>
                            </table></td>
                        </tr>
                        --%>
                        <%--
                        <tr>
                          <td>&nbsp;</td>
                        </tr>
                        <tr>
                          <td>The following are Secured Limits:</td>
                        </tr>
                        <tr>
                          <td><table width="100%" border="0" cellspacing="0" cellpadding="0" class="tblInfo">
                              <thead>
                                <tr>
                                  <td width="4%">S/N</td>
                                  <td width="9%">Limit ID</td>
                                  <td width="5%">Co-borrower LE <br>ID/Name</td>
                                  <td width="10%">Limit Booking Location</td>
                                  <td width="7%">Product Desc</td>
                                  <td width="9%">Outer Limit ID</td>
                                  <td width="13%">Approved Limit</td>
                                  <td widht="13%">Limit Maturity Date</td>
                                  <td width="13%">DDN Limit&nbsp;<font color="#00AAFF">* </font></td>
                                  <td width="9%">Security ID</td>
                                  <td width="7%">Security<br />Type</td>
                                  <td width="7%">Issue DDN</td>
                                </tr>
                              </thead>
                              <tbody>
<logic:present name="notcleanddnitems"  >
   <logic:iterate id="compResult" name="notcleanddnitems" type="com.integrosys.base.techinfra.diff.CompareResult"  >
<%
    IDDNItem OB = (IDDNItem)compResult.getObj();
    String rowClass="";
    row++;
    ssno++;
    if(ssno%2!=0){
       rowClass="odd";
    }else{
       rowClass="even";
    }
    
    //CMS 1995 By Hai Tao
    boolean isDeletedLimit = false;
    if (OB.getLimitStatus() != null) {
        isDeletedLimit = OB.getLimitStatus().equalsIgnoreCase(ICMSConstant.STATE_DELETED);
    }

   		if(isDeletedLimit){
    	anyDeletedLimit = true;
    	}
    
    	
    String prodDesc= "-";
    boolean partial = OB.getIsDDNIssuedInd();
	if(OB.getProductDesc()!=null) {
		prodDesc = OB.getProductDesc();
		if(prodDesc !=null)
		{
			if(CommonDataSingleton.getCodeCategoryLabelByValue( CategoryCodeConstant.PRODUCT_DESCRIPTION, prodDesc)!=null)
		   prodDesc=CommonDataSingleton.getCodeCategoryLabelByValue( CategoryCodeConstant.PRODUCT_DESCRIPTION,prodDesc);
		}
	}
   %>
        <tr class="<%=rowClass%>">
              <td class=<% if (partial && certTrxVal.getTransactionSubType() == null) { %>
                          'indexdiff'
                        <% } else { %>
	                      '<bean:write name="compResult" property="key" />'
	                    <% } %>><%=ssno%></td>
              <td>&nbsp;<%=OB.getLimitRef()%>
              <%if(isDeletedLimit){%>
                  <br><font color="#FF0000" size="1"><br><strong>(Deleted)</strong></font>
                  <%}%>
              </td>
              
              <td>&nbsp;
              	<integro:empty-if-null value="<%=OB.getCoBorrowerLegalID()%>" />          
              	<br>
              	&nbsp;<integro:empty-if-null value="<%=OB.getCoBorrowerName()%>" />                           
              </td>
              
              <td>
              	&nbsp;<%=cList.getCountryName(OB.getLimitBookingLocation().getCountryCode())%> - <%= OB.getLimitBookingLocation().getOrganisationCode()%>
              </td>
              
              <td>&nbsp;<%=prodDesc%></td>
              
              <td <%=!OB.getIsInnerOuterSameBCA()?"class=outerlimit":" "%>>
              	<% 	if (!OB.getIsInnerOuterSameBCA()) { %>
              			<a href="#" onclick="viewDiffOuterLimitBca('<%=OB.getOuterLimitID()%>', '<%=OB.getLimitID()%>', '<%=OB.getOuterLimitProfileID()%>' )" >
              	<% 	} %>
              		<%=(OB.getOuterLimitRef()==null || OB.getOuterLimitRef().equals("0")) ? "-" : OB.getOuterLimitRef()%>
              	<% 	if (!OB.getIsInnerOuterSameBCA()) { %> </a> <% } %>
              </td>
                            
              <td class="amount">&nbsp;
                <integro:currency amount="<%=((IDDNItem)compResult.getObj()).getApprovedLimitAmount()%>" param="currency"  />
              	<%	if (OB.isInnerLimit()){	%>
              			(<integro:currency amount="<%=((IDDNItem)compResult.getObj()).getApprovedLimitAmount()%>" param="amount" />)
              	<%	} else {	%>  
              			<integro:currency amount="<%=((IDDNItem)compResult.getObj()).getApprovedLimitAmount()%>" param="amount"  />
              	<%	}	%>
              </td>
              <td><% if (OB.getMaturityDate() == null) { %>
                  -
                  <% } else { %>
                  <integro:date object="<%= OB.getMaturityDate() %>" />
                  <% } %>
              </td>
              <td class="amount">&nbsp;
                <integro:currency amount="<%=((IDDNItem)compResult.getObj()).getDDNAmount()%>" param="currency" />
              	<%	if (OB.isInnerLimit()) { %>
              			(<integro:currency amount="<%=((IDDNItem)compResult.getObj()).getDDNAmount()%>" param="amount" />)
              	<%	}else{	%>
                		<integro:currency amount="<%=((IDDNItem)compResult.getObj()).getDDNAmount()%>" param="amount" />
              	<%	}%>  
              </td>
              
              <td width="12%">
                <logic:iterate id="temp0" name="compResult" property="obj.DDNCollateralInfoList" >
                    <%=((DDNCollateralInfo)temp0).getCollateralRef()%><br>
                </logic:iterate>
              </td>
              
              <td width="12%">
                <logic:iterate id="temp1" name="compResult" property="obj.DDNCollateralInfoList" >
                    <bean:write name="temp1" property="collateralType.typeName" /><br>
                </logic:iterate>
              </td>
              
              <td style="text-align:center"><input name="checkbox" type="checkbox" disabled="true" value="checkbox" <%if(partial) { %>checked  <% }%> /></td>
              
        </tr>
</logic:iterate>
                        <tr class="odd">
                          <td class="total">&nbsp;</td>
                          <td class="total">&nbsp;</td>
                          <td class="total">&nbsp;</td>
                          <td class="total">&nbsp;</td>
                          <td class="total">&nbsp;</td>
                          <td class="total" style="text-align:right;padding-right:3px">Total</td>
                          <td class="total" style="text-align:right;padding-right:3px">&nbsp;<integro:currency amount="<%=notCleanAppAmt%>" /></td>
                          <td class="total">&nbsp;</td>
                          <td class="total" style="text-align:right;padding-right:3px">&nbsp;<integro:currency amount="<%=notCleanDDNAmt%>" /></td>
                          <td class="total">&nbsp;</td>                          
                          <td class="total">&nbsp;</td>
                          <td class="total">&nbsp;</td>
                        </tr>
            </logic:present>
<logic:notPresent name="notcleanddnitems" >
            <tr class="odd">
                <td colspan="12">There is no limit</td>
            </tr>
</logic:notPresent>


                              </tbody>
                            </table></td>
                        </tr>
                        --%>
    <%--                        
    <tr>
      <td><h3>Deferral Requested for</h3></td>
    </tr>
    <tr> 
      <td>
          <table width="100%" border="0" cellspacing="0" cellpadding="0" class="tblInfo">
            <thead> 
            <tr> 
              <td width="5%">S/N</td>
              <td width="12%">Doc Number</td>
              <td width="10%">Doc Code</td>
              <td width="21%">Doc Description</td>
              <td width="10%">Expiry of Deferment</td>
              <td width="10%">Extended Deferment Date</td>
              <!--td width="10%">DDN Valid For</td-->
              <td width="10%">Approval Date</td>
              <td width="12%">Approved By</td>
            </tr>
            </thead> 
            <tbody>
             <%
             int rowc=0;
             if (deferredList != null) {
             for (int x = 0; x < deferredList.size(); x++) {
                OBCMSTrxHistoryLog log = new OBCMSTrxHistoryLog();
	            ICheckListItem item = (ICheckListItem) deferredList.get(x); 
	            if (deferredApprovalList != null && deferredApprovalList.size() > x)
	              log = (OBCMSTrxHistoryLog) deferredApprovalList.get(x);
	            String rowClass="";
				rowc++;
				if(rowc%2!=0){
				  rowClass="odd";
				}else{
				  rowClass="even";
				}
				
             %>
              <tr class="<%=rowClass%>">
                  <td class="index"><%=rowc%></td>
	              <td ><%= item.getCheckListItemRef()%>&nbsp;</td>
	              <td ><%= item.getItemCode() %>&nbsp;</td>
	              <td ><%= item.getItemDesc() %>&nbsp;</td>
	              <td ><integro:date object="<%= item.getDeferExpiryDate() %>"/>&nbsp;</td>
	              <td ><integro:date object="<%= item.getDeferExtendedDate() %>"/>&nbsp;</td>
	              <!--td >
	              	<% //	if (bcaApprovedDate == null) { %>
	                 		0&nbsp;
	              	<%/* 	} else {
		               		Date d1 = null;
	                   		if (item.getDeferExtendedDate() != null) {
	                    	 	d1 = item.getDeferExtendedDate();
                       		} else {
 	                     		d1 = item.getDeferExpiryDate();
                       		}
 	                   		Date d2 = cal.getTime();
 	                   		if (d1.before(d2)) {	*/%>
		             			0         
	              	<%//   	} else { 	%>
		              			<!--%= CommonUtil.dateDiff(d1, d2, Calendar.DATE)%-->
	              	<%/*
                       		}
                     	}*/
                   	%>
                  </td-->
					
					<%
                     	Calendar cal2 = null;
                     	if (log.getLogDate()!= null) {
	                     	//cal2 = new GregorianCalendar(Integer.parseInt(log.getLogDate().substring(6,10)), Integer.parseInt(log.getLogDate().substring(3,5))-1, Integer.parseInt(log.getLogDate().substring(0,2)) );
                            String logDate = log.getLogDate().indexOf(" ") != -1 ? log.getLogDate().split(" ")[0] : "";
                            System.out.println("Log Date 2 : " + logDate);
                            String[] _temp = logDate.indexOf("/") != -1 ? logDate.split("/") : null;
                            System.out.println("TEMP : " + _temp);
                            String year = null;
                            String month = null;
                            String day = null;
                            System.out.println("Year : " + year + " Month : " + month + " Day : " + day);
                            if (_temp != null) {
                                day = _temp[0];
                                month = _temp[1];
                                year = _temp[2];

                                cal2 = new GregorianCalendar(Integer.parseInt(year), Integer.parseInt(month) - 1, Integer.parseInt(day));
                            }
                     	}   
                  	%>
	              <td >
					<% if (cal2 != null) { %>
						<integro:date object="<%=cal2.getTime()%>"/>
					<% } else { %>
						&nbsp;
					<% } %>
				  </td>
				  
	              <td >
	              	<integro:empty-if-null value="<%=log.getLogUserName()%>"/>&nbsp;
          			(<integro:empty-if-null value="<%=log.getLogGroupName()%>"/>)
          		  </td>
              </tr>
             <% } } %>
             <% if (rowc==0) { %>
               <tr> 
                 <td colspan="9">There is no document.</td>
               </tr>             
             <% } %>
            </tbody>
           </table>
      </td>
    </tr>
    --%>
                        <tr><td></td></tr>
                        <tr>
                            <td>
                                <table width="100%" align="center" class="tblInfo" border="0" cellSpacing="0" cellPadding="0">
                                    <TBODY>
                                        <TR>
                                            <TD class="<%=CompareOBUtil.compOB(cert,actCert,"releaseTo") ? "fieldname" : "fieldnamediff"%>">Released To</TD>
                                            <TD class="odd"><SPAN class="even"><%--<INPUT size="50">--%><integro:empty-if-null value="<%=cert.getReleaseTo()%>"/></SPAN></TD>
                                        </TR>
                                        <TR class="odd">
                                            <TD class="<%=CompareOBUtil.compOB(cert,actCert,"remarks") ? "fieldname" : "fieldnamediff"%>">Reason / Remarks</TD>
                                            <TD>&nbsp;</TD>
                                        </TR>
                                        <tr>
                                          <td colspan="2" width="100%" class="odd"><textarea onkeyup="checkTextSize()" name="remarks" rows=10 cols=100 WRAP="soft"><%=remarks%></textarea>
                                          <span id="warningRemarks"></span></td>
                                        </tr>
                                        
                                    </TBODY>
                                </table>
                                <%--<textarea style="width: 100%;" rows="5" name="remarksSCC"></textarea>--%>
                            </td>
                        </tr>
                        <tr>
                          <td><hr /></td>
                        </tr>
                        <tr>
                          <td><table width="100%" border="0" align="center" cellpadding="0" cellspacing="0" class="tblInput">
                              <thead>
                                <tr>
                                  <td colspan="4" style="text-align:left">Authorised Personnel 1</td>
                                </tr>
                              </thead>
                              <tbody>
                                <tr class="odd">
                                  <td width="20%" class="<%=CompareOBUtil.compOB(cert,actCert,"creditOfficerName")? "fieldname":"fieldnamediff"%>" >Name<%--&nbsp;<font color="#0000FF">* </font>--%></td>
                                  <td width="30%">&nbsp;
                                    <integro:empty-if-null value="<%=cert.getCreditOfficerName()%>" />                                     
                                  </td>
                                  <td width="20%" class="<%=CompareOBUtil.compOB(cert,actCert,"creditOfficerSignNo")? "fieldname":"fieldnamediff"%>" >Signing Number<%--&nbsp;<font color="#0000FF">* </font>--%></td>
                                  <td width="30%">&nbsp;
                                    <integro:empty-if-null value="<%=cert.getCreditOfficerSignNo()%>" />
                                  </td>
                                </tr>
                                <%--
                                <tr class="even">
                                <%  if (actCert != null)
                                    {
                                %><td width="20%" class="<%=CompareOBUtil.compOB(cert.getCreditOfficerLocation(),actCert.getCreditOfficerLocation(),"countryCode")? "fieldname":"fieldnamediff"%>" >Location Country</td>
                                <%  }
                                    else
                                    {
                                %><td width="20%" class="<%=CompareOBUtil.compOB(cert.getCreditOfficerLocation(),null,"countryCode")? "fieldname":"fieldnamediff"%>" >Location Country</td>
                                <%  }%>
                                  <td width="30%">&nbsp;
                                    <integro:empty-if-null value="<%=cList.getCountryName(cert.getCreditOfficerLocation().getCountryCode())%>" />
                                  </td>
                                <%  if (actCert != null)
                                    {
                                %><td width="20%" class="<%=CompareOBUtil.compOB(cert.getCreditOfficerLocation(),actCert.getCreditOfficerLocation(),"organisationCode")? "fieldname":"fieldnamediff"%>" >Location Org Code</td>
                                <%  }
                                    else
                                    {
                                %><td width="20%" class="<%=CompareOBUtil.compOB(cert.getCreditOfficerLocation(),null,"organisationCode")? "fieldname":"fieldnamediff"%>" >Location Org Code</td>
                                <%  }%>
                                  <td width="30%">&nbsp;
                                    <integro:empty-if-null value="<%=orgList.getOrgCodeLabel(cert.getCreditOfficerLocation().getOrganisationCode())%>" />
                                  </td>
                                </tr>
                                --%>
                              </tbody>
                            </table>
                          </td>
                        </tr>
                        <tr>
                          <td>
                            <table width="100%" border="0" align="center" cellpadding="0" cellspacing="0" class="tblInput">
                              <thead>
                                <tr>
                                  <td colspan="4" style="text-align:left">Authorised Personnel 2
                                  </td>
                                </tr>
                              </thead>
                              <tbody>
                                <tr class="even">
                                  <td width="20%" class="<%=CompareOBUtil.compOB(cert,actCert,"seniorOfficerName")? "fieldname":"fieldnamediff"%>">Name</td>
                                  <td width="30%">&nbsp;
                                    <integro:empty-if-null value="<%=cert.getSeniorOfficerName()%>" />
                                  </td>
                                  <td width="20%" class="<%=CompareOBUtil.compOB(cert,actCert,"seniorOfficerSignNo")? "fieldname":"fieldnamediff"%>">Signing Number</td>
                                  <td width="30%">&nbsp;
                                    <integro:empty-if-null value="<%=cert.getSeniorOfficerSignNo()%>" />
                                  </td>
                                </tr>
                                <%--
                                <tr class="even">
                                <%  if (actCert != null)
                                    {
                                %><td width="20%" class="<%=CompareOBUtil.compOB(cert.getSeniorOfficerLocation(),actCert.getSeniorOfficerLocation(),"countryCode")? "fieldname":"fieldnamediff"%>" >Location Country</td>
                                <%  }
                                    else
                                    {
                                %><td width="20%" class="<%=CompareOBUtil.compOB(cert.getSeniorOfficerLocation(),null,"countryCode")? "fieldname":"fieldnamediff"%>" >Location Country</td>
                                <%  }%>
                                  <td width="30%">&nbsp;
                                    <integro:empty-if-null value="<%=cList.getCountryName(cert.getSeniorOfficerLocation().getCountryCode())%>" />
                                  </td>
                                <%  if (actCert != null)
                                    {
                                %><td width="20%" class="<%=CompareOBUtil.compOB(cert.getSeniorOfficerLocation(),actCert.getSeniorOfficerLocation(),"organisationCode")? "fieldname":"fieldnamediff"%>" >Location Org Code</td>
                                <%  }
                                    else
                                    {
                                %><td width="20%" class="<%=CompareOBUtil.compOB(cert.getSeniorOfficerLocation(),null,"organisationCode")? "fieldname":"fieldnamediff"%>" >Location Org Code</td>
                                <%  }%>
                                  <td width="30%">&nbsp;
                                    <integro:empty-if-null value="<%=orgList.getOrgCodeLabel(cert.getSeniorOfficerLocation().getOrganisationCode())%>" />
                                  </td>
                                </tr>
                                --%>
                              </tbody>
                            </table></td>
                        </tr>                       		
                        <tr>
                          <td>&nbsp;</td>
                        </tr>                  
                        <tr>
                          <td><table width="100%" border="0" align="center" cellpadding="0" cellspacing="0" class="tblInfo">
                            <thead></thead>
                              <tbody>
                                <!--
                                <tr>
                                  <td class="<%=CompareOBUtil.compOB(cert,actCert,"remarks")? "fieldname":"fieldnamediff"%>" width="20%" class="fieldname">Remarks</td>
                                  <td width="80%" class="odd"><textarea onkeyup="checkTextSize()"  name="remarks" rows=16 cols=70 WRAP="soft"><%=remarks%></textarea>
                                  <span id="warningRemarks"></span></td>
                                </tr>
                                -->
                                <tr>
                                  <td class="fieldname">Last Action By</td>
                                  <td class="even">&nbsp;<%=lastActionBy%></td>
                                </tr>
                                <tr class="odd">
                                  <td class="fieldname">Last Remarks Made</td>
                                  <td><integro:wrapper value="<%=remarks%>" />&nbsp;</td>
                                </tr>
                              </tbody>
                            </table>
                         </td>
                        </tr>
                      </tbody>
                    </table>
                    <table width="240" border="0" align="center" cellpadding="0" cellspacing="0">
                      <tr>
                        <td width="89">&nbsp;</td>
                        <td width="81">&nbsp;</td>
                        <td width="70">&nbsp;</td>
                      </tr>
                      <tr>
                       <%--<%if(!anyDeletedLimit){%>--%>
                        <td><a href="#" onclick="approve()" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image8','','img/approve2.gif',1)"><img src="img/approve1.gif" name="Image8" width="80" height="20" border="0" id="Image8" /></a></td>
                        <%--<%}
                        else{
	                     %>
                        <td><a href="#" onclick="notapprove()" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image8','','img/approve2.gif',1)"><img src="img/approve1.gif" name="Image8" width="80" height="20" border="0" id="Image8" /></a></td>
                        <%}%>--%>
                        <td><a href="#" onclick="reject()" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image9','','img/reject2.gif',1)"><img src="img/reject1.gif" name="Image9" width="70" height="20" border="0" id="Image9" /></a></td>
                        <td><a href="ToDo.do" onmouseout="MM_swapImgRestore()" onmouseover="MM_swapImage('Image1','','img/cancel2.gif',1)"><img src="img/cancel1.gif" name="Image1"border="0" id="Image1" /></a></td>
                      </tr>
                      <tr>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                      </tr>
                    </table>
                    <!-- InstanceEndEditable --> </div>
				
</html:form>
</body>
<!-- InstanceEnd --></html>
<%
	}
	catch (Exception e) {
		e.printStackTrace();
	}
%>
